

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../../../">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ise.data.process &mdash; ise 1.1.0 documentation</title>
      <link rel="stylesheet" type="text/css" href="../../../_static/pygments.css?v=80d5e7a1" />
      <link rel="stylesheet" type="text/css" href="../../../_static/css/theme.css?v=e59714d7" />

  
    <link rel="canonical" href="/_modules/ise/data/process.html" />
      <script src="../../../_static/jquery.js?v=5d32c60e"></script>
      <script src="../../../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../../../_static/documentation_options.js?v=fc837d61"></script>
      <script src="../../../_static/doctools.js?v=9a2dae69"></script>
      <script src="../../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            ise
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"></div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">ise</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">ise.data.process</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for ise.data.process</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">warnings</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>

<span class="kn">import</span> <span class="nn">cftime</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>

<span class="kn">from</span> <span class="nn">ise.data.scaler</span> <span class="kn">import</span> <span class="n">LogScaler</span><span class="p">,</span> <span class="n">RobustScaler</span><span class="p">,</span> <span class="n">StandardScaler</span>
<span class="kn">from</span> <span class="nn">ise.models.dim_reducers.pca</span> <span class="kn">import</span> <span class="n">PCA</span>
<span class="kn">from</span> <span class="nn">ise.utils.functions</span> <span class="kn">import</span> <span class="n">get_all_filepaths</span>


<div class="viewcode-block" id="GridProcessor">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.GridProcessor">[docs]</a>
<span class="k">class</span> <span class="nc">GridProcessor</span><span class="p">:</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="SectorProcessor">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.SectorProcessor">[docs]</a>
<span class="k">class</span> <span class="nc">SectorProcessor</span><span class="p">:</span>
    <span class="k">pass</span></div>



<div class="viewcode-block" id="ProjectionProcessor">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.ProjectionProcessor">[docs]</a>
<span class="k">class</span> <span class="nc">ProjectionProcessor</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for processing ice sheet data.</span>

<span class="sd">    Attributes:</span>
<span class="sd">    - ice_sheet (str): Ice sheet to be processed. Must be &#39;AIS&#39; or &#39;GIS&#39;.</span>
<span class="sd">    - forcings_directory (str): The path to the directory containing the forcings data.</span>
<span class="sd">    - projections_directory (str): The path to the directory containing the projections data.</span>
<span class="sd">    - scalefac_path (str): The path to the netCDF file containing scaling factors for each grid cell.</span>
<span class="sd">    - densities_path (str): The path to the CSV file containing ice and ocean density (rhow/rhoi) data for each experiment.</span>

<span class="sd">    Methods:</span>
<span class="sd">    - __init__(self, ice_sheet, forcings_directory, projections_directory, scalefac_path=None, densities_path=None): Initializes the Processor object.</span>
<span class="sd">    - process_forcings(self): Processes the forcings data.</span>
<span class="sd">    - process_projections(self, output_directory): Processes the projections data.</span>
<span class="sd">    - _calculate_ivaf_minus_control(self, data_directory, densities_fp, scalefac_path): Calculates the ice volume above flotation (IVAF) for each file in the given data directory, subtracting out the control projection IVAF if applicable.</span>
<span class="sd">    - _calculate_ivaf_single_file(self, directory, densities, scalefac_model, ctrl_proj=False): Calculates the ice volume above flotation (IVAF) for a single file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ice_sheet</span><span class="p">,</span>
        <span class="n">forcings_directory</span><span class="p">,</span>
        <span class="n">projections_directory</span><span class="p">,</span>
        <span class="n">scalefac_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">densities_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcings_directory</span> <span class="o">=</span> <span class="n">forcings_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projections_directory</span> <span class="o">=</span> <span class="n">projections_directory</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">densities_path</span> <span class="o">=</span> <span class="n">densities_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scalefac_path</span> <span class="o">=</span> <span class="n">scalefac_path</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">=</span> <span class="n">ice_sheet</span><span class="o">.</span><span class="n">upper</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;gris&quot;</span><span class="p">,</span> <span class="s2">&quot;gis&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">=</span> <span class="s2">&quot;GIS&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">=</span> <span class="mi">5</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;GIS&quot;</span> <span class="k">else</span> <span class="mi">8</span>

<div class="viewcode-block" id="ProjectionProcessor.process">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.ProjectionProcessor.process">[docs]</a>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process the ISMIP6 projections by calculating IVAF for both control</span>
<span class="sd">        and experiments, subtracting out the control IVAF from experiments,</span>
<span class="sd">        and exporting ivaf files.</span>

<span class="sd">        Args:</span>
<span class="sd">            output_directory (str): The directory to save the processed projections.</span>

<span class="sd">        Raises:</span>
<span class="sd">            ValueError: If projections_directory or output_directory is not specified.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 1 indicating successful processing.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">projections_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Projections path must be specified&quot;</span><span class="p">)</span>

        <span class="c1"># if the last ivaf file is missing, assume none of them are and calculate and export all ivaf files</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span>
        <span class="p">):</span>  <span class="c1"># and not os.path.exists(f&quot;{self.projections_directory}/VUW/PISM/exp08/ivaf_GIS_VUW_PISM_exp08.nc&quot;):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ivaf_minus_control</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projections_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">densities_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalefac_path</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;GIS&quot;</span>
        <span class="p">):</span>  <span class="c1"># and not os.path.exists(f&quot;{self.projections_directory}/VUW/PISM/exp04/ivaf_AIS_VUW_PISM_exp04.nc&quot;):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ivaf_minus_control</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projections_directory</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">densities_path</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">scalefac_path</span>
            <span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span></div>


    <span class="k">def</span> <span class="nf">_calculate_ivaf_minus_control</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">data_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">densities_fp</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">scalefac_path</span><span class="p">:</span> <span class="nb">str</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculates the ice volume above flotation (IVAF) for each file in the given data directory,</span>
<span class="sd">        subtracting out the control projection IVAF if applicable.</span>

<span class="sd">        Args:</span>
<span class="sd">        - data_directory (str): path to directory containing the data files to process</span>
<span class="sd">        - densities_fp (str or pd.DataFrame): filepath to CSV file containing density data, or a pandas DataFrame</span>
<span class="sd">        - scalefac_path (str): path to netCDF file containing scaling factors for each grid cell</span>

<span class="sd">        Returns:</span>
<span class="sd">        - int: 1 indicating successful calculation.</span>

<span class="sd">        Raises:</span>
<span class="sd">        - ValueError: if densities_fp is None or not a string or pandas DataFrame</span>

<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># error handling for densities argument (must be str filepath or dataframe)</span>
        <span class="k">if</span> <span class="n">densities_fp</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;densities_fp must be specified. Run get_model_densities() to get density data.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">densities_fp</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">densities</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">densities_fp</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">densities_fp</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;densities argument must be a string or a pandas DataFrame.&quot;</span><span class="p">)</span>

        <span class="c1"># open scaling model</span>
        <span class="n">scalefac_model</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">scalefac_path</span><span class="p">)</span>
        <span class="n">scalefac_model</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="n">scalefac_model</span><span class="o">.</span><span class="n">af2</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>

        <span class="c1"># adjust scaling model based on desired resolution</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
            <span class="n">scalefac_model</span> <span class="o">=</span> <span class="n">scalefac_model</span><span class="p">[::</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">,</span> <span class="p">::</span> <span class="bp">self</span><span class="o">.</span><span class="n">resolution</span><span class="p">]</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;GIS&quot;</span> <span class="ow">and</span> <span class="n">scalefac_model</span><span class="o">.</span><span class="n">shape</span> <span class="o">!=</span> <span class="p">(</span><span class="mi">337</span><span class="p">,</span> <span class="mi">577</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">scalefac_model</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">==</span> <span class="mi">6081</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Scalefac model must be 337x577 for GIS, received </span><span class="si">{</span><span class="n">scalefac_model</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">. Make sure you are using the GIS scaling model and not the AIS.&quot;</span>
                <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Scalefac model must be 337x577 for GIS, received </span><span class="si">{</span><span class="n">scalefac_model</span><span class="o">.</span><span class="n">shape</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>

        <span class="c1"># get all files in directory with &quot;ctrl_proj&quot; and &quot;exp&quot; in them and store separately</span>
        <span class="n">ctrl_proj_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">exp_dirs</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">data_directory</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">dirs</span><span class="p">:</span>
                <span class="k">if</span> <span class="s2">&quot;ctrl_proj&quot;</span> <span class="ow">in</span> <span class="n">directory</span><span class="p">:</span>
                    <span class="n">ctrl_proj_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
                <span class="k">elif</span> <span class="s2">&quot;exp&quot;</span> <span class="ow">in</span> <span class="n">directory</span><span class="p">:</span>
                    <span class="n">exp_dirs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">directory</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">pass</span>

        <span class="c1"># first calculate ivaf for control projections</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">ctrl_proj_dirs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ivaf_single_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">scalefac_model</span><span class="p">,</span> <span class="n">ctrl_proj</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># then, for each experiment, calculate ivaf and subtract out control</span>
        <span class="c1"># exp_dirs = exp_dirs[65:]</span>
        <span class="k">for</span> <span class="n">directory</span> <span class="ow">in</span> <span class="n">exp_dirs</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_calculate_ivaf_single_file</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">scalefac_model</span><span class="p">,</span> <span class="n">ctrl_proj</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_calculate_ivaf_single_file</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">densities</span><span class="p">,</span> <span class="n">scalefac_model</span><span class="p">,</span> <span class="n">ctrl_proj</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Calculate the Ice Volume Above Floatation (IVAF) for a single file.</span>

<span class="sd">        Args:</span>
<span class="sd">            directory (str): The directory path of the file.</span>
<span class="sd">            densities (pandas.DataFrame): A DataFrame containing density values for different groups and models.</span>
<span class="sd">            scalefac_model (float): The scale factor for the model.</span>
<span class="sd">            ctrl_proj (bool, optional): Flag indicating whether the projection is a control projection. Defaults to False.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 1 if the processing is successful, -1 otherwise.</span>


<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># directory = r&quot;/gpfs/data/kbergen/pvankatw/pvankatw-bfoxkemp/GHub-ISMIP6-Projection-GrIS/AWI/ISSM1/exp09&quot;</span>
        <span class="c1"># get metadata from path</span>

        <span class="n">path</span> <span class="o">=</span> <span class="n">directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">group</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>

        <span class="c1"># Determine which control to use based on experiment (only applies to AIS) per Nowicki, 2020</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl_proj</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;exp01&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;exp02&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;exp03&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;exp04&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;exp11&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expA1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expA2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expA3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expA4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expB1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expB2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expB3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expB4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expB5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC8&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC11&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE2&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE3&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE5&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE11&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE12&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE13&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expE14&quot;</span><span class="p">,</span>
                <span class="p">):</span>
                    <span class="n">ctrl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="sa">f</span><span class="s2">&quot;ctrl_proj_open/ivaf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_ctrl_proj_open.nc&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="p">(</span>
                    <span class="n">exp</span>
                    <span class="ow">in</span> <span class="p">(</span>
                        <span class="s2">&quot;exp05&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp06&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp07&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp08&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp09&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp10&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp12&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;exp13&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expA5&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expA6&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expA7&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expA8&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expB6&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expB7&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expB8&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expB9&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expB10&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expC3&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expC6&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expC9&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expC12&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE6&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE7&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE8&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE9&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE10&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE15&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE16&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE17&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;expE18&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                    <span class="ow">or</span> <span class="s2">&quot;expD&quot;</span> <span class="ow">in</span> <span class="n">exp</span>
                <span class="p">):</span>
                    <span class="n">ctrl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                        <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                        <span class="sa">f</span><span class="s2">&quot;ctrl_proj_std/ivaf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_ctrl_proj_std.nc&quot;</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">(</span>
                    <span class="s2">&quot;expC1&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC4&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC7&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;expC10&quot;</span><span class="p">,</span>
                <span class="p">):</span>  <span class="c1"># N/A value for ocean_forcing in Nowicki, 2020 table A2</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Experiment </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> not recognized. Skipped.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># GrIS doesn&#39;t have ctrl_proj_open vs ctrl_proj_std</span>
                <span class="n">ctrl_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span>
                    <span class="s2">&quot;/&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]),</span>
                    <span class="sa">f</span><span class="s2">&quot;ctrl_proj/ivaf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_ctrl_proj.nc&quot;</span><span class="p">,</span>
                <span class="p">)</span>

            <span class="c1"># for some reason there is no ctrl_proj_open for AWI and JPL1, skip</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;AWI&quot;</span> <span class="ow">and</span> <span class="s2">&quot;ctrl_proj_open&quot;</span> <span class="ow">in</span> <span class="n">ctrl_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;JPL1&quot;</span> <span class="ow">and</span> <span class="s2">&quot;ctrl_proj_open&quot;</span> <span class="ow">in</span> <span class="n">ctrl_path</span><span class="p">:</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># MUN_GISM1 is corrupted, skip</span>
        <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;MUN&quot;</span> <span class="ow">and</span> <span class="n">model</span> <span class="o">==</span> <span class="s2">&quot;GSM1&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># folder is empty, skip</span>
        <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;IMAU&quot;</span> <span class="ow">and</span> <span class="n">exp</span> <span class="o">==</span> <span class="s2">&quot;exp11&quot;</span><span class="p">:</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>
        <span class="c1"># bed file in NCAR_CISM/expD10 is empty, skip</span>
        <span class="k">elif</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;NCAR&quot;</span> <span class="ow">and</span> <span class="n">exp</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;expD10&quot;</span><span class="p">,</span> <span class="s2">&quot;expD11&quot;</span><span class="p">):</span>
            <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># lookup densities from csv</span>
        <span class="n">subset_densities</span> <span class="o">=</span> <span class="n">densities</span><span class="p">[(</span><span class="n">densities</span><span class="o">.</span><span class="n">group</span> <span class="o">==</span> <span class="n">group</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">densities</span><span class="o">.</span><span class="n">model</span> <span class="o">==</span> <span class="n">model</span><span class="p">)]</span>
        <span class="n">rhoi</span> <span class="o">=</span> <span class="n">subset_densities</span><span class="o">.</span><span class="n">rhoi</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">rhow</span> <span class="o">=</span> <span class="n">subset_densities</span><span class="o">.</span><span class="n">rhow</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># load data</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span> <span class="ow">and</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;ULB&quot;</span><span class="p">:</span>
            <span class="c1"># ULB uses fETISh for AIS naming, not actual model name (fETISh_16km or fETISh_32km)</span>
            <span class="n">naming_convention</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_fETISh_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">.nc&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">naming_convention</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">.nc&quot;</span>

        <span class="c1"># load data</span>
        <span class="n">bed</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;topg_</span><span class="si">{</span><span class="n">naming_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span>
        <span class="p">)</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;lithk_</span><span class="si">{</span><span class="n">naming_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span>
        <span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sftgif_</span><span class="si">{</span><span class="n">naming_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span>
        <span class="p">)</span>
        <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span>
            <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;sftgrf_</span><span class="si">{</span><span class="n">naming_convention</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span>
        <span class="p">)</span>

        <span class="c1"># bed = xr.open_dataset(os.path.join(directory, f&#39;topg_{naming_convention}&#39;), decode_times=False)</span>
        <span class="c1"># thickness = xr.open_dataset(os.path.join(directory, f&#39;lithk_{naming_convention}&#39;), decode_times=False)</span>
        <span class="c1"># mask = xr.open_dataset(os.path.join(directory, f&#39;sftgif_{naming_convention}&#39;), decode_times=False)</span>
        <span class="c1"># ground_mask = xr.open_dataset(os.path.join(directory, f&#39;sftgrf_{naming_convention}&#39;), decode_times=False)</span>
        <span class="n">length_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>
        <span class="c1"># note on decode_times=False -- by doing so, it stays in &quot;days from&quot; rather than trying to infer a type. Makes handling much more predictable.</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
            <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

        <span class="c1"># if time is not a dimension, add copies for each time step</span>
        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bed</span><span class="o">.</span><span class="n">dims</span> <span class="ow">or</span> <span class="n">bed</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span>
                    <span class="p">[</span>
                        <span class="s2">&quot;time&quot;</span><span class="p">,</span>
                    <span class="p">]</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
            <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">length_time</span><span class="p">})</span>

            <span class="k">if</span> <span class="n">length_time</span> <span class="o">==</span> <span class="mi">86</span><span class="p">:</span>
                <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">[</span>
                    <span class="s2">&quot;time&quot;</span>
                <span class="p">]</span>  <span class="c1"># most times just the bed file is missing the time index</span>
            <span class="k">elif</span> <span class="n">length_time</span> <span class="o">&gt;</span> <span class="mi">86</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">)):</span>  <span class="c1"># has duplicates</span>
                    <span class="n">keep_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">],</span> <span class="n">return_index</span><span class="o">=</span><span class="kc">True</span><span class="p">)[</span>
                        <span class="mi">1</span>
                    <span class="p">]</span>  <span class="c1"># find non-duplicates</span>
                    <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">keep_indices</span><span class="p">)</span>  <span class="c1"># only select non-duplicates</span>
                    <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">keep_indices</span><span class="p">)</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">keep_indices</span><span class="p">)</span>
                    <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="n">keep_indices</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;At least one file in </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> does not have a time index formatted correctly. Attempting to fix.&quot;</span>
                    <span class="p">)</span>
                    <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">86</span>
                    <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>
                    <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                        <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>
                    <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                    <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                        <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">ground_mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                    <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot fix time index for </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> due to duplicate index values. Skipped.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2"> time points for </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">. Skipped.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="c1"># if -9999 instead of np.nan, replace (come back and optimize? couldn&#39;t figure out with xarray)</span>
        <span class="k">if</span> <span class="n">bed</span><span class="o">.</span><span class="n">topg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9999.0</span> <span class="ow">or</span> <span class="n">bed</span><span class="o">.</span><span class="n">topg</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&gt;=</span> <span class="mi">9999</span><span class="p">:</span>
            <span class="n">topg</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">topg</span><span class="o">.</span><span class="n">values</span>
            <span class="n">topg</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">topg</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">topg</span> <span class="o">&gt;=</span> <span class="mi">9999</span><span class="p">)))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;topg&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">topg</span>
            <span class="k">del</span> <span class="n">topg</span>

            <span class="n">lithk</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">lithk</span><span class="o">.</span><span class="n">values</span>
            <span class="n">lithk</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">lithk</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">lithk</span> <span class="o">&gt;=</span> <span class="mi">9999</span><span class="p">)))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;lithk&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">lithk</span>
            <span class="k">del</span> <span class="n">lithk</span>

            <span class="n">sftgif</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sftgif</span><span class="o">.</span><span class="n">values</span>
            <span class="n">sftgif</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sftgif</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sftgif</span> <span class="o">&gt;=</span> <span class="mi">9999</span><span class="p">)))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;sftgif&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sftgif</span>
            <span class="k">del</span> <span class="n">sftgif</span>

            <span class="n">sftgrf</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">sftgrf</span><span class="o">.</span><span class="n">values</span>
            <span class="n">sftgrf</span><span class="p">[(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">((</span><span class="n">sftgrf</span> <span class="o">&lt;=</span> <span class="o">-</span><span class="mf">9999.0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">sftgrf</span> <span class="o">&gt;=</span> <span class="mi">9999</span><span class="p">)))]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">ground_mask</span><span class="p">[</span><span class="s2">&quot;sftgrf&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">=</span> <span class="n">sftgrf</span>
            <span class="k">del</span> <span class="n">sftgrf</span>

        <span class="c1"># converts time (in &quot;days from X&quot; to numpy.datetime64) and subsets time from 2015 to 2100</span>

        <span class="c1"># a few datasets do not have the time index formatted correctly</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">86</span><span class="p">:</span>
                <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">[</span>
                    <span class="s2">&quot;time&quot;</span>
                <span class="p">]</span>  <span class="c1"># most times just the bed file is missing the time index</span>
            <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">86</span><span class="p">:</span>
                <span class="c1"># bed[&#39;time&#39;] = thickness[&#39;time&#39;].copy()</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;At least one file in </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> does not have a time index formatted correctly. Attempting to fix.&quot;</span>
                <span class="p">)</span>
                <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">86</span>
                <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>
                <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]))</span>
                <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                    <span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">ground_mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="n">start_idx</span><span class="p">],</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
                <span class="p">)</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Cannot fix time index for </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2"> due to duplicate index values. Skipped.&quot;</span>
                    <span class="p">)</span>
                    <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Only </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">bed</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2"> time points for </span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">. Skipped.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="o">-</span><span class="mi">1</span>

        <span class="n">bed</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">bed</span><span class="p">)</span>
        <span class="n">thickness</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
        <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">ground_mask</span><span class="p">)</span>
        <span class="n">length_time</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">time</span><span class="p">)</span>

        <span class="c1"># Interpolate values for x &amp; y, for formatting purposes only, does not get used</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">thickness</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">))</span> <span class="o">!=</span> <span class="nb">len</span><span class="p">(</span><span class="n">scalefac_model</span><span class="p">):</span>
            <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">bed</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate_values</span><span class="p">(</span><span class="n">bed</span><span class="p">)</span>
            <span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">thickness</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate_values</span><span class="p">(</span><span class="n">thickness</span><span class="p">)</span>
            <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate_values</span><span class="p">(</span><span class="n">mask</span><span class="p">)</span>
            <span class="n">ground_mask</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">],</span> <span class="n">ground_mask</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">interpolate_values</span><span class="p">(</span><span class="n">ground_mask</span><span class="p">)</span>

        <span class="c1"># clip masks if they are below 0 or above 1</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sftgif</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sftgif</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mask</span><span class="p">[</span><span class="s2">&quot;sftgif&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">mask</span><span class="o">.</span><span class="n">sftgif</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">ground_mask</span><span class="o">.</span><span class="n">sftgrf</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">ground_mask</span><span class="o">.</span><span class="n">sftgrf</span><span class="o">.</span><span class="n">values</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">ground_mask</span><span class="p">[</span><span class="s2">&quot;sftgrf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">clip</span><span class="p">(</span><span class="n">ground_mask</span><span class="o">.</span><span class="n">sftgrf</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">,</span> <span class="mf">1.0</span><span class="p">)</span>

        <span class="c1"># if time is not a dimension, add copies for each time step</span>
        <span class="c1"># if &#39;time&#39; not in bed.dims or bed.dims[&#39;time&#39;] == 1:</span>
        <span class="c1">#     try:</span>
        <span class="c1">#         bed = bed.drop_vars([&#39;time&#39;,])</span>
        <span class="c1">#     except ValueError:</span>
        <span class="c1">#         pass</span>
        <span class="c1">#     bed = bed.expand_dims(dim={&#39;time&#39;: length_time})</span>

        <span class="c1"># flip around axes so the order is (x, y, time)</span>
        <span class="n">bed</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="n">bed_data</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">topg</span><span class="o">.</span><span class="n">values</span>

        <span class="n">thickness</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="n">thickness_data</span> <span class="o">=</span> <span class="n">thickness</span><span class="o">.</span><span class="n">lithk</span><span class="o">.</span><span class="n">values</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="n">mask_data</span> <span class="o">=</span> <span class="n">mask</span><span class="o">.</span><span class="n">sftgif</span><span class="o">.</span><span class="n">values</span>

        <span class="n">ground_mask</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
        <span class="n">ground_mask_data</span> <span class="o">=</span> <span class="n">ground_mask</span><span class="o">.</span><span class="n">sftgrf</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># for each time step, calculate ivaf</span>
        <span class="n">ivaf</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">bed_data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">length_time</span><span class="p">):</span>

            <span class="c1"># get data slices for current time</span>
            <span class="n">thickness_i</span> <span class="o">=</span> <span class="n">thickness_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">bed_i</span> <span class="o">=</span> <span class="n">bed_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">mask_i</span> <span class="o">=</span> <span class="n">mask_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ground_mask_i</span> <span class="o">=</span> <span class="n">ground_mask_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

            <span class="c1"># set data slices to zero where mask = 0 or any value is NaN</span>
            <span class="n">thickness_i</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mask_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">thickness_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ground_mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bed_i</span><span class="p">))</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">bed_i</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mask_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">thickness_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ground_mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bed_i</span><span class="p">))</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">ground_mask_i</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mask_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">thickness_i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ground_mask_i</span><span class="p">)</span>
                <span class="o">|</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bed_i</span><span class="p">)</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">mask_i</span><span class="p">[</span>
                <span class="p">(</span><span class="n">mask_i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">thickness_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">ground_mask_i</span><span class="p">))</span>
                <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">bed_i</span><span class="p">))</span>
            <span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># take min(bed_i, 0)</span>
            <span class="n">bed_i</span><span class="p">[</span><span class="n">bed_i</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="c1"># calculate IVAF (based on MATLAB processing scripts from Seroussi, 2021)</span>
            <span class="n">hf_i</span> <span class="o">=</span> <span class="n">thickness_i</span> <span class="o">+</span> <span class="p">((</span><span class="n">rhow</span> <span class="o">/</span> <span class="n">rhoi</span><span class="p">)</span> <span class="o">*</span> <span class="n">bed_i</span><span class="p">)</span>
            <span class="n">masked_output</span> <span class="o">=</span> <span class="n">hf_i</span> <span class="o">*</span> <span class="n">ground_mask_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">*</span> <span class="n">mask_data</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span>
            <span class="n">ivaf</span><span class="p">[:,</span> <span class="p">:,</span> <span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">masked_output</span> <span class="o">*</span> <span class="n">scalefac_model</span> <span class="o">*</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">resolution</span> <span class="o">*</span> <span class="mi">1000</span><span class="p">)</span> <span class="o">**</span> <span class="mi">2</span>

        <span class="c1"># subtract out control if for an experment</span>
        <span class="n">ivaf_nc</span> <span class="o">=</span> <span class="n">bed</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>  <span class="c1"># copy file structure and metadata for ivaf file</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl_proj</span><span class="p">:</span>
            <span class="c1"># open control dataset</span>
            <span class="n">ivaf_ctrl</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
                <span class="n">ctrl_path</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

            <span class="c1"># subtract out control</span>
            <span class="c1"># ivaf = ivaf_ctrl.ivaf.values - ivaf</span>
            <span class="n">ivaf_with_ctrl</span> <span class="o">=</span> <span class="n">ivaf</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
            <span class="n">ivaf</span> <span class="o">=</span> <span class="n">ivaf</span> <span class="o">-</span> <span class="n">ivaf_ctrl</span><span class="o">.</span><span class="n">ivaf</span><span class="o">.</span><span class="n">values</span>

        <span class="c1"># save ivaf file (copied format from bed_data, change accordingly.)</span>
        <span class="n">ivaf_nc</span><span class="p">[</span><span class="s2">&quot;ivaf&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">ivaf</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">ctrl_proj</span><span class="p">:</span>
            <span class="n">ivaf_nc</span><span class="p">[</span><span class="s1">&#39;ivaf_with_control&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="p">((</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">),</span> <span class="n">ivaf_with_ctrl</span><span class="p">)</span>
        <span class="n">ivaf_nc</span> <span class="o">=</span> <span class="n">ivaf_nc</span><span class="o">.</span><span class="n">drop_vars</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="s2">&quot;topg&quot;</span><span class="p">,</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">ivaf_nc</span><span class="p">[</span><span class="s2">&quot;sle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">ivaf_nc</span><span class="o">.</span><span class="n">ivaf</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="mf">362.5</span>
        <span class="n">export_nc_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;ivaf_</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">.nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">export_nc_path</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">export_nc_path</span><span class="p">)</span>
        <span class="n">ivaf_nc</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
            <span class="n">export_nc_path</span>
        <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">group</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">: Processing successful.&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">1</span></div>



<div class="viewcode-block" id="convert_and_subset_times">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.convert_and_subset_times">[docs]</a>
<span class="k">def</span> <span class="nf">convert_and_subset_times</span><span class="p">(</span>
    <span class="n">dataset</span><span class="p">,</span>
<span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cftime</span><span class="o">.</span><span class="n">_cftime</span><span class="o">.</span><span class="n">DatetimeNoLeap</span><span class="p">)</span> <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">cftime</span><span class="o">.</span><span class="n">_cftime</span><span class="o">.</span><span class="n">Datetime360Day</span>
    <span class="p">):</span>
        <span class="n">datetimeindex</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">indexes</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_datetimeindex</span><span class="p">()</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">datetimeindex</span>

    <span class="k">elif</span> <span class="p">(</span>
        <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int32</span><span class="p">)</span>
        <span class="ow">or</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">int64</span><span class="p">)</span>
    <span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;units&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="n">units</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">attrs</span><span class="p">[</span><span class="s2">&quot;unit&quot;</span><span class="p">]</span>
        <span class="n">units</span> <span class="o">=</span> <span class="n">units</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;days since &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>

        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;2000-1-0&quot;</span><span class="p">:</span>  <span class="c1"># VUB AISMPALEO</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;2000-1-1&quot;</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;day&quot;</span><span class="p">:</span>  <span class="c1"># NCAR CISM exp7 - &quot;day as %Y%m%d.%f&quot;?</span>
            <span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;2014-1-1&quot;</span>

        <span class="k">if</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;seconds&quot;</span><span class="p">:</span>  <span class="c1"># VUW PISM -- seconds since 1-1-1 00:00:00</span>
            <span class="n">start_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span>
                <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="s2">&quot;0001-01-01 00:00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">)</span>
            <span class="p">)</span>
            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">&quot;s&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="p">)</span>
        <span class="k">elif</span> <span class="n">units</span> <span class="o">==</span> <span class="s2">&quot;2008-1-1&quot;</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="mf">157785.0</span><span class="p">:</span>  <span class="c1"># UAF?</span>
            <span class="c1"># every 5 years but still len(time) == 86.. assume we keep them all for 2015-2100</span>
            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">x</span><span class="si">}</span><span class="s2">-01-01 00:00:00&quot;</span><span class="p">,</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2"> %H:%M:%S&quot;</span><span class="p">))</span>
                    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2015</span><span class="p">,</span> <span class="mi">2101</span><span class="p">)</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;days since &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;%Y-%m-</span><span class="si">%d</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">start_date</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">datetime64</span><span class="p">(</span>
                    <span class="n">datetime</span><span class="o">.</span><span class="n">strptime</span><span class="p">(</span><span class="n">units</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;days since &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;</span><span class="si">%d</span><span class="s2">-%m-%Y&quot;</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span><span class="n">start_date</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">timedelta64</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="p">),</span> <span class="s2">&quot;D&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">]</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time values are not recognized: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">86</span><span class="p">:</span>
        <span class="c1"># make sure the max date is 2100</span>
        <span class="c1"># dataset = dataset.sel(time=slice(np.datetime64(&#39;2014-01-01&#39;), np.datetime64(&#39;2101-01-01&#39;)))</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="s2">&quot;2012-01-01&quot;</span><span class="p">,</span> <span class="s2">&quot;2101-01-01&quot;</span><span class="p">))</span>

        <span class="c1"># if you still have more than 86, take the previous 86 values from 2100</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">86</span><span class="p">:</span>
            <span class="c1"># LSCE GRISLI has two 2015 measurements</span>

            <span class="c1"># dataset = dataset.sel(time=slice(dataset.time.values[len(dataset.time) - 86], dataset.time.values[-1]))</span>
            <span class="n">start_idx</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">-</span> <span class="mi">86</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isel</span><span class="p">(</span><span class="n">time</span><span class="o">=</span><span class="nb">slice</span><span class="p">(</span><span class="n">start_idx</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)))</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">86</span><span class="p">:</span>
        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
            <span class="s2">&quot;After subsetting there are still not 86 time points. Go back and check logs.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;dataset_length=</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span><span class="si">}</span><span class="s2"> -- </span><span class="si">{</span><span class="n">dataset</span><span class="o">.</span><span class="n">attrs</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>



<div class="viewcode-block" id="get_model_densities">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.get_model_densities">[docs]</a>
<span class="k">def</span> <span class="nf">get_model_densities</span><span class="p">(</span><span class="n">zenodo_directory</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">output_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extracts values for rhoi and rhow from NetCDF files in the specified directory and returns a pandas DataFrame</span>
<span class="sd">    containing the group, model, rhoi, and rhow values for each file.</span>

<span class="sd">    Args:</span>
<span class="sd">        zenodo_directory (str): The path to the directory containing the NetCDF files.</span>
<span class="sd">        output_path (str, optional): The path to save the resulting DataFrame as a CSV file.</span>

<span class="sd">    Returns:</span>
<span class="sd">        pandas.DataFrame: A DataFrame containing the group, model, rhoi, and rhow values for each file.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">results</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">root</span><span class="p">,</span> <span class="n">dirs</span><span class="p">,</span> <span class="n">files</span> <span class="ow">in</span> <span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">zenodo_directory</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">):</span>  <span class="c1"># Check if the file is a NetCDF file</span>
                <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">root</span><span class="p">,</span> <span class="n">file</span><span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Open the NetCDF file using xarray</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span>
                        <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="o">...</span>
                    <span class="p">)</span>

                    <span class="c1"># Extract values for rhoi and rhow</span>
                    <span class="k">if</span> <span class="s2">&quot;rhoi&quot;</span> <span class="ow">in</span> <span class="n">dataset</span> <span class="ow">and</span> <span class="s2">&quot;rhow&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="p">:</span>
                        <span class="n">rhoi_values</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;rhoi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
                        <span class="n">rhow_values</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;rhow&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>

                        <span class="c1"># Append the filename and values to the results list</span>
                        <span class="n">results</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;rhoi&quot;</span><span class="p">:</span> <span class="n">rhoi_values</span><span class="p">,</span> <span class="s2">&quot;rhow&quot;</span><span class="p">:</span> <span class="n">rhow_values</span><span class="p">})</span>

                    <span class="c1"># Close the dataset</span>
                    <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error processing </span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">densities</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">results</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;ctrl_proj&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;hist&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]:</span>
            <span class="k">continue</span>

        <span class="k">elif</span> <span class="s2">&quot;ILTS&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;ILTS_PIK&quot;</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>

        <span class="k">elif</span> <span class="s2">&quot;ULB_fETISh&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="s2">&quot;ULB&quot;</span>
            <span class="n">model</span> <span class="o">=</span> <span class="s2">&quot;fETISh_32km&quot;</span> <span class="k">if</span> <span class="s2">&quot;32km&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;fETISh_16km&quot;</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">fp</span> <span class="o">=</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
            <span class="n">group</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">fp</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
        <span class="n">densities</span><span class="o">.</span><span class="n">append</span><span class="p">([</span><span class="n">group</span><span class="p">,</span> <span class="n">model</span><span class="p">,</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;rhoi&quot;</span><span class="p">],</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;rhow&quot;</span><span class="p">]])</span>

    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">densities</span><span class="p">,</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;group&quot;</span><span class="p">,</span> <span class="s2">&quot;model&quot;</span><span class="p">,</span> <span class="s2">&quot;rhoi&quot;</span><span class="p">,</span> <span class="s2">&quot;rhow&quot;</span><span class="p">])</span>
    <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rhoi&quot;</span><span class="p">],</span> <span class="n">df</span><span class="p">[</span><span class="s2">&quot;rhow&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">rhoi</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">),</span> <span class="n">df</span><span class="o">.</span><span class="n">rhow</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s2">&quot;float&quot;</span><span class="p">)</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">drop_duplicates</span><span class="p">()</span>

    <span class="n">ice_sheet</span> <span class="o">=</span> <span class="s2">&quot;AIS&quot;</span> <span class="k">if</span> <span class="s2">&quot;AIS&quot;</span> <span class="ow">in</span> <span class="n">file</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="k">else</span> <span class="s2">&quot;GIS&quot;</span>

    <span class="k">if</span> <span class="n">output_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">output_path</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">):</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_path</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_densities.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">output_path</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="interpolate_values">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.interpolate_values">[docs]</a>
<span class="k">def</span> <span class="nf">interpolate_values</span><span class="p">(</span><span class="n">data</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpolates missing values in the x and y dimensions of the input NetCDF data using linear interpolation.</span>

<span class="sd">    Args:</span>
<span class="sd">        data: A NetCDF file containing x and y dimensions with missing values.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A tuple containing the interpolated x and y arrays.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">y</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">y</span><span class="o">.</span><span class="n">interpolate</span><span class="p">())</span>

    <span class="c1"># first and last are NaNs, replace with correct values</span>
    <span class="n">y</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">y</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

    <span class="n">x</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">NaN</span><span class="p">)</span>
    <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">interpolate</span><span class="p">())</span>

    <span class="c1"># first and last are NaNs, replace with correct values</span>
    <span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">+</span> <span class="p">(</span><span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="o">-</span> <span class="n">x</span><span class="p">[</span><span class="o">-</span><span class="mi">3</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span></div>



<div class="viewcode-block" id="DimensionalityReducer">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer">[docs]</a>
<span class="k">class</span> <span class="nc">DimensionalityReducer</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span> <span class="n">forcing_dir</span><span class="p">,</span> <span class="n">projection_dir</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaling_method</span><span class="o">=</span><span class="kc">None</span>
    <span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">forcing_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Forcing directory must be specified.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Output directory must be specified.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span> <span class="o">=</span> <span class="n">forcing_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_dir</span> <span class="o">=</span> <span class="n">projection_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;all&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;atmosphere&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span> <span class="s2">&quot;ocean&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">}</span>

        <span class="c1"># check inputs</span>
        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/pca_models/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/pca_models/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/scalers/&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/scalers/&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="o">=</span> <span class="n">scaling_method</span>

        <span class="k">if</span> <span class="n">ice_sheet</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;AIS&quot;</span><span class="p">,</span> <span class="s2">&quot;GrIS&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Ice sheet must be specified and must be &#39;AIS&#39; or &#39;GrIS&#39;.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">=</span> <span class="n">ice_sheet</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gris&quot;</span><span class="p">:</span>
            <span class="n">atmospheric_files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span><span class="p">,</span>
                <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span>
                <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;Atmosphere_Forcing/aSMB_observed/v1&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">atmospheric_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atmospheric_files</span> <span class="k">if</span> <span class="s2">&quot;combined&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

            <span class="c1"># files in atmopheric directory are separated by year, needs to be combined</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">atmospheric_files</span><span class="p">:</span>
                <span class="n">combine_gris_forcings</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span><span class="p">)</span>

            <span class="n">oceanic_files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span><span class="p">,</span>
                <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span>
                <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;Ocean_Forcing/Melt_Implementation/v4&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmospheric_files</span> <span class="o">+</span> <span class="n">oceanic_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">atmospheric_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">oceanic_files</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">all_forcing_fps</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
                <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_dir</span><span class="p">,</span>
                <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span>
                <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;1995-2100&quot;</span><span class="p">,</span>
                <span class="n">not_contains</span><span class="o">=</span><span class="s2">&quot;Ice_Shelf_Fracture&quot;</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">all_forcing_fps</span> <span class="k">if</span> <span class="s2">&quot;8km&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s2">&quot;v1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Atmosphere_Forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Ocean_Forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span>
            <span class="p">]</span>

        <span class="n">all_projection_fps</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_dir</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;ivaf&quot;</span><span class="p">,</span> <span class="n">not_contains</span><span class="o">=</span><span class="s2">&quot;ctrl_proj&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span> <span class="o">=</span> <span class="n">all_projection_fps</span>

    <span class="c1"># def reduce_dimensionlity(self, forcing_dir: str=None, output_dir: str=None):</span>
    <span class="c1"># generate pca models</span>
    <span class="c1"># convert each forcing file to pca space</span>

<div class="viewcode-block" id="DimensionalityReducer.generate_pca_models">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer.generate_pca_models">[docs]</a>
    <span class="k">def</span> <span class="nf">generate_pca_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_forcing_pcs</span><span class="p">,</span> <span class="n">num_projection_pcs</span><span class="p">,</span> <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate principal component analysis (PCA) models for atmosphere and ocean variables.</span>

<span class="sd">        Parameters:</span>
<span class="sd">        - atmosphere_fps (list): List of file paths for atmosphere data.</span>
<span class="sd">        - ocean_fps (list): List of file paths for ocean data.</span>
<span class="sd">        - save_dir (str): Directory to save the generated PCA models and results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check inputs and make directories for outputted models</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/pca_models/&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/pca_models/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/pca_models/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/scalers/&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/scalers/&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/scalers/&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="o">=</span> <span class="n">scaling_method</span>

        <span class="c1"># Train PCA models for each atmospheric and oceanic forcing variable and save</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_ais_atmosphere_pcas</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_forcing_pcs</span><span class="p">,</span>
                <span class="n">scaler_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_ais_ocean_pcas</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_forcing_pcs</span><span class="p">,</span>
                <span class="n">scaler_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_gris_atmosphere_pcas</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_forcing_pcs</span><span class="p">,</span>
                <span class="n">scaler_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_generate_gris_ocean_pcas</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_forcing_pcs</span><span class="p">,</span>
                <span class="n">scaler_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>

        <span class="c1"># Train PCA model for SLE and save</span>
        <span class="n">sle_paths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_dir</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;ivaf&quot;</span><span class="p">,</span> <span class="n">not_contains</span><span class="o">=</span><span class="s2">&quot;ctrl&quot;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_generate_sle_pca</span><span class="p">(</span>
            <span class="n">sle_paths</span><span class="p">,</span>
            <span class="n">save_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
            <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_projection_pcs</span><span class="p">,</span>
            <span class="n">scaler_dir</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
            <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DimensionalityReducer.convert_forcings">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer.convert_forcings">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_forcings</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">forcing_files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pca_model_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Converts atmospheric and oceanic forcing files to PCA space using pretrained PCA models.</span>

<span class="sd">        Args:</span>
<span class="sd">            forcing_files (list, optional): List of specific forcing files to convert. If not provided, all files in the directory will be used. Default is None.</span>
<span class="sd">            pca_model_directory (str, optional): Directory containing the pretrained PCA models. If not provided, the directory specified during object initialization will be used. Default is None.</span>
<span class="sd">            output_dir (str, optional): Directory to save the converted files. If not provided, the directory specified during object initialization will be used. Default is None.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 indicating successful conversion.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># check inputs for validity</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scaling_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Scalers must be generated first, or scaling_method must be identified if they already exist. Run DimensionalityReducer.generate_pca_models first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="o">=</span> <span class="n">scaling_method</span>

        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="n">pca_model_directory</span>

        <span class="c1"># if user supplies specific forcing files (rather than entire directory), use that instead</span>
        <span class="c1"># TODO: test this..</span>
        <span class="k">if</span> <span class="n">forcing_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;By using specific forcing files, forcing_paths attribute will be overwritten.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forcing_files</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Atmosphere_Forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span>
            <span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                <span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;all&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;Ocean_Forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span>
            <span class="p">]</span>

        <span class="c1"># ATMOSPHERIC FORCINGS</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/forcings/&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/forcings/&quot;</span><span class="p">)</span>

        <span class="c1"># for each atmospheric forcing file, convert each variable to PCA space with pretrained PCA model</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">]),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;atmosphere&quot;</span><span class="p">]),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting atmospheric forcing files to PCA space&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># dataset = xr.open_dataset(path, decode_times=False, engine=&#39;netcdf4&#39;, ).transpose(&#39;time&#39;, &#39;y&#39;, &#39;x&#39;, ...)  # open the dataset</span>
            <span class="c1"># if len(dataset.dims) &gt; 3:</span>
            <span class="c1">#     drop_dims = [x for x in list(dataset.dims) if x not in (&#39;time&#39;, &#39;x&#39;, &#39;y&#39;)]</span>
            <span class="c1">#     dataset = dataset.drop_dims(drop_dims)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">forcing_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get metadata (model, ssp, etc.)</span>

            <span class="c1"># transform each variable in the dataset with their respective trained PCA model</span>
            <span class="n">transformed_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>

                <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span>
                    <span class="s2">&quot;evspsbl_anomaly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;mrro_anomaly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;pr_anomaly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;smb_anomaly&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;ts_anomaly&quot;</span><span class="p">,</span>
                <span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                            <span class="n">dataset</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                            <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                            <span class="n">pca_model_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                            <span class="n">scaler_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                            <span class="n">scaling_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>  <span class="c1"># if a variable is missing (usually mrro_anomaly), skip it</span>
                        <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">forcing_name</span><span class="si">}</span><span class="s2">. Skipped.&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="n">transformed_data</span><span class="p">[</span>
                        <span class="n">var</span>
                    <span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span>  <span class="c1"># store in dict with structure {&#39;var_name&#39;: transformed_var}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                        <span class="n">dataset</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span>
                        <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                        <span class="n">pca_model_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                        <span class="n">scaler_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                        <span class="n">scaling_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable </span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2"> not found in </span><span class="si">{</span><span class="n">forcing_name</span><span class="si">}</span><span class="s2">. Skipped.&quot;</span><span class="p">)</span>
                <span class="n">transformed_data</span><span class="p">[</span>
                    <span class="n">var</span>
                <span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span>  <span class="c1"># store in dict with structure {&#39;var_name&#39;: transformed_var}</span>

                <span class="k">if</span> <span class="n">transformed</span><span class="o">.</span><span class="n">isnan</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="ow">or</span> <span class="n">transformed</span><span class="o">.</span><span class="n">isinf</span><span class="p">()</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                    <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;NaN or inf values found in converted </span><span class="si">{</span><span class="n">forcing_name</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

            <span class="c1"># create a dataframe with rows corresponding to time (106 total) and columns corresponding to each variables principal components</span>
            <span class="n">compiled_transformed_forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">transformed_data</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
                <span class="n">var_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                    <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_pc</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
                <span class="p">)</span>
                <span class="n">compiled_transformed_forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                    <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">compiled_transformed_forcings</span><span class="p">,</span> <span class="n">var_df</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>

            <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">compiled_transformed_forcings</span><span class="p">)</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/forcings/PCA_</span><span class="si">{</span><span class="n">forcing_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span>
            <span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s1">&#39;atmosphere&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s1">&#39;atmosphere&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> atmospheric forcing files converted to PCA space.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished converting atmospheric forcings to PCA space, files outputted to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

        <span class="c1"># OCEANIC FORCINGS</span>

        <span class="c1"># for each ocean forcing file, convert each variable to PCA space with pretrained PCA model</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">]),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">]),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting oceanic forcing files&quot;</span><span class="p">,</span>
        <span class="p">):</span>

            <span class="c1"># open the dataset</span>
            <span class="n">forcing_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>  <span class="c1"># get metadata (model, ssp, etc.)</span>

            <span class="c1"># get variable name by splitting the filepath name</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">4</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)</span>
                <span class="k">if</span> <span class="s2">&quot;basinRunoff&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;basin_runoff&quot;</span>
                <span class="k">elif</span> <span class="s2">&quot;oceanThermalForcing&quot;</span> <span class="ow">in</span> <span class="n">metadata</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;thermal_forcing&quot;</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s2">&quot;ocean&quot;</span><span class="p">][</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;forcing&quot;</span> <span class="ow">or</span> <span class="n">var</span> <span class="o">==</span> <span class="s2">&quot;thermal&quot;</span><span class="p">:</span>
                <span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;thermal_forcing&quot;</span>

            <span class="c1"># get forcing array (requires mean value over z dimensions, see get_xarray_data())</span>
            <span class="n">forcing_array</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span>
                <span class="n">path</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>

            <span class="c1"># transform each variable in the dataset with their respective trained PCA model</span>
            <span class="n">transformed_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">forcing_array</span><span class="p">,</span>
                <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">pca_model_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">scaler_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">transformed_data</span><span class="p">[</span>
                <span class="n">var</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span>  <span class="c1"># store in dict with structure {&#39;var_name&#39;: transformed_var}</span>

            <span class="c1"># create a dataframe with rows corresponding to time (86 total) and columns corresponding to each variables principal components</span>
            <span class="n">variable_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_pc</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
            <span class="p">)</span>
            <span class="n">variable_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/forcings/PCA_</span><span class="si">{</span><span class="n">forcing_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s1">&#39;ocean&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">[</span><span class="s1">&#39;ocean&#39;</span><span class="p">])</span><span class="si">}</span><span class="s2"> oceanic forcing files converted to PCA space.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Finished converting oceanic forcings to PCA space, files outputted to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">.&quot;</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DimensionalityReducer.convert_projections">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer.convert_projections">[docs]</a>
    <span class="k">def</span> <span class="nf">convert_projections</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">projection_files</span><span class="p">:</span> <span class="nb">list</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">pca_model_directory</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">output_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># check inputs for validity</span>
        <span class="n">output_dir</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="k">if</span> <span class="n">output_dir</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="n">output_dir</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scaling_method</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;Scalers must be generated first, or scaling_method must be identified if they already exist. Run DimensionalityReducer.generate_pca_models first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span> <span class="o">=</span> <span class="n">scaling_method</span>

        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="n">pca_model_directory</span>

        <span class="c1"># if user supplies specific projection files (rather than entire directory), use that instead</span>
        <span class="k">if</span> <span class="n">projection_files</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;By using specific projection files, projection_paths attribute will be overwritten.&quot;</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span> <span class="o">=</span> <span class="n">projection_files</span>

        <span class="c1"># make a folder in output directory for converted projections</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/projections/&quot;</span><span class="p">):</span>
            <span class="n">os</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/projections/&quot;</span><span class="p">)</span>

        <span class="c1"># for each projection file, convert ivaf to PCA space with pretrained PCA model</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">path</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">),</span>
            <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">),</span>
            <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Converting projection files to PCA space&quot;</span><span class="p">,</span>
        <span class="p">):</span>
            <span class="c1"># get forcing array (requires mean value over z dimensions, see get_xarray_data())</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">projection_array</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;sle&quot;</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">projection_array</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;ivaf&quot;</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">)</span>
                <span class="n">projection_array</span> <span class="o">=</span> <span class="n">projection_array</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="mf">362.5</span>

            <span class="c1"># nan_indices = np.argwhere(np.isnan(projection_array))</span>
            <span class="c1"># print(len(nan_indices))</span>
            <span class="c1"># continue</span>

            <span class="c1"># projection_array = np.nan_to_num(projection_array)  # deal with np.nans</span>
            <span class="n">var</span> <span class="o">=</span> <span class="s2">&quot;sle&quot;</span>
            <span class="c1"># projection_array = np.nan_to_num(projection_array)  # there shouldn&#39;t be nans...</span>
            <span class="n">projection_name</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span>
                <span class="o">-</span><span class="mi">1</span>
            <span class="p">]</span>  <span class="c1"># get metadata (model, ssp, etc.)</span>

            <span class="c1"># transform each variable in the dataset with their respective trained PCA model</span>
            <span class="n">transformed_data</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">transformed</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span>
                <span class="n">projection_array</span><span class="p">,</span>
                <span class="n">var_name</span><span class="o">=</span><span class="n">var</span><span class="p">,</span>
                <span class="n">pca_model_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span>
                <span class="n">scaler_directory</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span>
                <span class="n">scaling_method</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">scaling_method</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="n">transformed_data</span><span class="p">[</span>
                <span class="n">var</span>
            <span class="p">]</span> <span class="o">=</span> <span class="n">transformed</span>  <span class="c1"># store in dict with structure {&#39;var_name&#39;: transformed_var}</span>

            <span class="c1"># create a dataframe with rows corresponding to time (86 total) and columns corresponding to each variables principal components</span>
            <span class="n">variable_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span>
                <span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">],</span>
                <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_pc</span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">transformed_data</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])],</span>
            <span class="p">)</span>
            <span class="n">variable_df</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">])</span>
            <span class="n">variable_df</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">path</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">variable_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/projections/PCA_</span><span class="si">{</span><span class="n">projection_name</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">)</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">)</span><span class="si">}</span><span class="s2"> projection files converted to PCA space.&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Finished converting projections to PCA space, files outputted to </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span></div>


    <span class="k">def</span> <span class="nf">_generate_ais_atmosphere_pcas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">atmosphere_fps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="s2">&quot;95%&quot;</span><span class="p">,</span>
        <span class="n">scaler_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate principal component analysis (PCA) for atmospheric variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            atmosphere_fps (list): List of file paths to atmospheric CMIP files.</span>
<span class="sd">            save_dir (str): Directory to save the PCA results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 if successful.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># if no separate directory for saving scalers is specified, use the pca save_dir</span>
        <span class="k">if</span> <span class="n">scaler_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

        <span class="c1"># for each variable</span>

        <span class="n">var_names</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;pr_anomaly&quot;</span><span class="p">,</span> <span class="s2">&quot;evspsbl_anomaly&quot;</span><span class="p">,</span> <span class="s2">&quot;mrro_anomaly&quot;</span><span class="p">,</span> <span class="s2">&quot;smb_anomaly&quot;</span><span class="p">,</span> <span class="s2">&quot;ts_anomaly&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
            <span class="nb">enumerate</span><span class="p">(</span><span class="n">var_names</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">var_names</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing atmospheric PCA&quot;</span>
        <span class="p">):</span>
            <span class="n">variable_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">atmosphere_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">])</span>

            <span class="c1"># loop through each atmospheric CMIP file and combine them into one big array</span>
            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">atmosphere_fps</span><span class="p">):</span>

                <span class="c1"># get the variable you need (rather than the entire dataset)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="c1"># data_array = convert_and_subset_times(dataset)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">var</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
                    <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="c1"># store it in the total array</span>
                <span class="n">variable_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data_flattened</span>

            <span class="c1"># deal with np.nans -- since it&#39;s an anomaly, replace with 0</span>
            <span class="n">variable_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>

            <span class="c1"># reshape variable_array (num_files, num_timestamps, num_gridpoints) --&gt; (num_files*num_timestamps, num_gridpoints)</span>
            <span class="n">variable_array</span> <span class="o">=</span> <span class="n">variable_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">atmosphere_fps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>

            <span class="c1"># scale data</span>
            <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
                <span class="n">variable_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
                <span class="n">variable_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
            <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
                <span class="n">variable_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
            <span class="n">variable_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>
            <span class="n">variable_array</span> <span class="o">=</span> <span class="n">variable_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>

            <span class="c1"># run PCA</span>
            <span class="n">pca</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">variable_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>

            <span class="c1"># output pca object</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/AIS_pca_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">.pth&quot;</span>
            <span class="n">pca</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>
            <span class="c1"># and scaler</span>
            <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/AIS_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_scaler.pth&quot;</span>
            <span class="n">variable_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_generate_ais_ocean_pcas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ocean_fps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="s2">&quot;95%&quot;</span><span class="p">,</span>
        <span class="n">scaler_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate principal component analysis (PCA) for ocean variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            ocean_fps (list): List of file paths for ocean variables.</span>
<span class="sd">            save_dir (str): Directory to save the PCA results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 if PCA generation is successful, -1 otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">scaler_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

        <span class="n">thermal_forcing_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ocean_fps</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">salinity_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ocean_fps</span> <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">temperature_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ocean_fps</span> <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">])</span>
        <span class="n">salinity_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">salinity_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">])</span>
        <span class="n">temperature_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">])</span>

        <span class="c1"># get the variables you need (rather than the entire dataset)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing thermal_forcing PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># data_array = convert_and_subset_times(dataset)</span>
            <span class="n">thermal_forcing_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;thermal_forcing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span>
            <span class="p">)</span>  <span class="c1"># store</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing salinity PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">salinity_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># data_array = convert_and_subset_times(dataset)</span>
            <span class="n">salinity_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>  <span class="c1"># store</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing temperature PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">temperature_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># data_array = convert_and_subset_times(dataset)</span>
            <span class="n">temperature_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>

        <span class="c1"># reshape variable_array (num_files, num_timestamps, num_gridpoints) --&gt; (num_files*num_timestamps, num_gridpoints)</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">thermal_forcing_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span>
        <span class="p">)</span>
        <span class="n">salinity_array</span> <span class="o">=</span> <span class="n">salinity_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">salinity_fps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>
        <span class="n">temperature_array</span> <span class="o">=</span> <span class="n">temperature_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temperature_fps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86</span><span class="p">,</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span><span class="p">)</span>

        <span class="c1"># remove nans</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>
        <span class="n">salinity_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">salinity_array</span><span class="p">)</span>
        <span class="n">temperature_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">temperature_array</span><span class="p">)</span>

        <span class="c1"># scale data</span>
        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">therm_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">therm_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">therm_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">therm_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">therm_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">salinity_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">salinity_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">salinity_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">salinity_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">salinity_array</span><span class="p">)</span>
        <span class="n">salinity_array</span> <span class="o">=</span> <span class="n">salinity_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">salinity_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">temp_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">temp_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">temp_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">temp_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">temperature_array</span><span class="p">)</span>
        <span class="n">temperature_array</span> <span class="o">=</span> <span class="n">temp_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">temperature_array</span><span class="p">)</span>

        <span class="c1"># run PCA</span>
        <span class="n">pca_tf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>
        <span class="n">pca_sal</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">salinity_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>
        <span class="n">pca_temp</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">temperature_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>

        <span class="c1"># get percent explained</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/AIS_pca_thermal_forcing.pth&quot;</span>
        <span class="n">pca_tf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/AIS_pca_salinity.pth&quot;</span>
        <span class="n">pca_sal</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/AIS_pca_temperature.pth&quot;</span>
        <span class="n">pca_temp</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="c1"># save scalers</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/AIS_scaler_thermal_forcing.pth&quot;</span>
        <span class="n">therm_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/AIS_scaler_temperature.pth&quot;</span>
        <span class="n">temp_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/AIS_scaler_salinity.pth&quot;</span>
        <span class="n">salinity_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_generate_gris_atmosphere_pcas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">atmosphere_fps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="s2">&quot;95%&quot;</span><span class="p">,</span>
        <span class="n">scaler_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># if no separate directory for saving scalers is specified, use the pca save_dir</span>
        <span class="k">if</span> <span class="n">scaler_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

        <span class="c1"># get SMB and ST paths</span>
        <span class="n">test_num</span> <span class="o">=</span> <span class="mi">5</span>
        <span class="n">aSMB_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atmosphere_fps</span> <span class="k">if</span> <span class="s2">&quot;aSMB_combined&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">test_num</span><span class="p">]</span>
        <span class="n">aST_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atmosphere_fps</span> <span class="k">if</span> <span class="s2">&quot;aST_combined&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">:</span><span class="n">test_num</span><span class="p">]</span>

        <span class="c1"># allocate memory</span>
        <span class="n">flattened_xy_dim</span> <span class="o">=</span> <span class="mi">337</span> <span class="o">*</span> <span class="mi">577</span>

        <span class="n">smb_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">aSMB_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">])</span>
        <span class="n">st_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">aST_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">])</span>
        <span class="c1"># get xarray dataset, format it, and put it in preallocated array</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing aSMB PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aSMB_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">smb_forcing_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;aSMB&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span>
            <span class="p">)</span>  <span class="c1"># store</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing aST PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aST_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">st_forcing_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;aST&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">)</span>  <span class="c1"># store</span>

        <span class="c1"># reshape variable_array (num_files, num_timestamps, num_gridpoints) --&gt; (num_files*num_timestamps, num_gridpoints)</span>
        <span class="n">smb_forcing_array</span> <span class="o">=</span> <span class="n">smb_forcing_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">aSMB_fps</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">flattened_xy_dim</span>
        <span class="p">)</span>
        <span class="n">st_forcing_array</span> <span class="o">=</span> <span class="n">st_forcing_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">aST_fps</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">flattened_xy_dim</span>
        <span class="p">)</span>

        <span class="c1"># remove nans</span>
        <span class="n">smb_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">smb_forcing_array</span><span class="p">)</span>
        <span class="n">st_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">st_forcing_array</span><span class="p">)</span>

        <span class="c1"># scale data</span>
        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">smb_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">smb_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">smb_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">smb_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">smb_forcing_array</span><span class="p">)</span>
        <span class="n">smb_forcing_array</span> <span class="o">=</span> <span class="n">smb_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">smb_forcing_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">st_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">st_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">st_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">st_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">st_forcing_array</span><span class="p">)</span>
        <span class="n">st_forcing_array</span> <span class="o">=</span> <span class="n">st_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">st_forcing_array</span><span class="p">)</span>

        <span class="c1"># run PCA</span>
        <span class="n">pca_smb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">smb_forcing_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>
        <span class="n">pca_st</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">st_forcing_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>

        <span class="c1"># save pca models</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/GrIS_pca_aSMB.pth&quot;</span>
        <span class="n">pca_smb</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/GrIS_pca_aST.pth&quot;</span>
        <span class="n">pca_st</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="c1"># save scalers</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/GrIS_aSMB_scaler.pth&quot;</span>
        <span class="n">smb_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/GrIS_aST_scaler.pth&quot;</span>
        <span class="n">st_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_generate_gris_ocean_pcas</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">ocean_fps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="s2">&quot;95%&quot;</span><span class="p">,</span>
        <span class="n">scaler_dir</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>

        <span class="c1"># if no separate directory for saving scalers is specified, use the pca save_dir</span>
        <span class="k">if</span> <span class="n">scaler_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

        <span class="n">basin_runoff_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ocean_fps</span> <span class="k">if</span> <span class="s2">&quot;basinRunoff&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
        <span class="n">thermal_forcing_fps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">ocean_fps</span> <span class="k">if</span> <span class="s2">&quot;oceanThermalForcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># allocate memory</span>
        <span class="n">flattened_xy_dim</span> <span class="o">=</span> <span class="mi">337</span> <span class="o">*</span> <span class="mi">577</span>
        <span class="n">basin_runoff_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">basin_runoff_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">])</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">])</span>

        <span class="c1"># get xarray dataset, format it, and put it in preallocated array</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing basin_runoff PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">basin_runoff_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">basin_runoff_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;basin_runoff&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span>
            <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Processing thermal_forcing PCA model.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">):</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">thermal_forcing_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;thermal_forcing&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span>
            <span class="p">)</span>

        <span class="c1"># reshape variable_array (num_files, num_timestamps, num_gridpoints) --&gt; (num_files*num_timestamps, num_gridpoints)</span>
        <span class="n">basin_runoff_array</span> <span class="o">=</span> <span class="n">basin_runoff_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">basin_runoff_fps</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">flattened_xy_dim</span>
        <span class="p">)</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">thermal_forcing_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">thermal_forcing_fps</span><span class="p">)</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="n">flattened_xy_dim</span>
        <span class="p">)</span>

        <span class="c1"># remove nans</span>
        <span class="n">basin_runoff_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">basin_runoff_array</span><span class="p">)</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>

        <span class="c1"># scale data</span>
        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">basin_runoff_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">basin_runoff_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">basin_runoff_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">basin_runoff_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">basin_runoff_array</span><span class="p">)</span>
        <span class="n">basin_runoff_array</span> <span class="o">=</span> <span class="n">basin_runoff_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">basin_runoff_array</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">thermal_forcing_scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">thermal_forcing_scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">thermal_forcing_scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">thermal_forcing_scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>
        <span class="n">thermal_forcing_array</span> <span class="o">=</span> <span class="n">thermal_forcing_scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">)</span>

        <span class="c1"># run PCA</span>
        <span class="n">pca_br</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">basin_runoff_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>
        <span class="n">pca_tf</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span><span class="n">thermal_forcing_array</span><span class="p">,</span> <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">)</span>

        <span class="c1"># save PCA</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/GrIS_pca_basin_runoff.pth&quot;</span>
        <span class="n">pca_br</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/GrIS_pca_thermal_forcing.pth&quot;</span>
        <span class="n">pca_tf</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="c1"># save scalers</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/GrIS_basin_runoff_scaler.pth&quot;</span>
        <span class="n">basin_runoff_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/GrIS_thermal_forcing_scaler.pth&quot;</span>
        <span class="n">thermal_forcing_scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_generate_sle_pca</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">sle_fps</span><span class="p">:</span> <span class="nb">list</span><span class="p">,</span>
        <span class="n">save_dir</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="s2">&quot;99%&quot;</span><span class="p">,</span>
        <span class="n">scaler_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Generate principal component analysis (PCA) for sea level equivalent (SLE) variables.</span>

<span class="sd">        Args:</span>
<span class="sd">            sle_fps (list): List of file paths for SLE variables.</span>
<span class="sd">            save_dir (str): Directory to save the PCA results.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: 0 if PCA generation is successful, -1 otherwise.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">scaler_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">scaler_dir</span> <span class="o">=</span> <span class="n">save_dir</span>

        <span class="c1"># get the flattened xy dimension</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
            <span class="n">flattened_xy_dim</span> <span class="o">=</span> <span class="mi">761</span> <span class="o">*</span> <span class="mi">761</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">flattened_xy_dim</span> <span class="o">=</span> <span class="mi">337</span> <span class="o">*</span> <span class="mi">577</span>

        <span class="c1"># allocate memory</span>
        <span class="n">sle_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">sle_fps</span><span class="p">),</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">])</span>

        <span class="c1"># loop through each SLE (IVAF) projection file</span>
        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">sle_fps</span><span class="p">),</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">sle_fps</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Aggregating SLE files&quot;</span><span class="p">):</span>
            <span class="c1"># get the variable</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;sle&quot;</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">)</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">get_xarray_data</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;ivaf&quot;</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="p">)</span>
                <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">data_flattened</span> <span class="o">/</span> <span class="mf">1e9</span> <span class="o">/</span> <span class="mf">362.5</span>

            <span class="c1"># store it in the total array</span>
            <span class="n">sle_array</span><span class="p">[</span><span class="n">i</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">data_flattened</span>

        <span class="c1"># reshape variable_array (num_files, num_timestamps, num_gridpoints) --&gt; (num_files*num_timestamps, num_gridpoints)</span>
        <span class="n">sle_array</span> <span class="o">=</span> <span class="n">sle_array</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sle_fps</span><span class="p">)</span> <span class="o">*</span> <span class="mi">86</span><span class="p">,</span> <span class="n">flattened_xy_dim</span><span class="p">)</span>

        <span class="c1"># since the array is so large (350*85, 761*761) = (29750, 579121), randomly sample N rows and run PCA</span>
        <span class="n">sle_array</span> <span class="o">=</span> <span class="n">sle_array</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">sle_array</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1590</span><span class="p">,</span> <span class="n">replace</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span> <span class="p">:]</span>

        <span class="c1"># deal with np.nans</span>
        <span class="n">sle_array</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">sle_array</span><span class="p">)</span>

        <span class="c1"># scale sle</span>
        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">StandardScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">RobustScaler</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">scaler</span> <span class="o">=</span> <span class="n">LogScaler</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">sle_array</span><span class="p">)</span>
        <span class="n">sle_array</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">sle_array</span><span class="p">)</span>

        <span class="c1"># run pca</span>
        <span class="n">pca</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_run_PCA</span><span class="p">(</span>
            <span class="n">sle_array</span><span class="p">,</span>
            <span class="n">num_pcs</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># output pca object</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">save_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_pca_sle.pth&quot;</span>
        <span class="n">pca</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="c1"># and scaler</span>
        <span class="n">save_path</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">scaler_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_scaler_sle.pth&quot;</span>
        <span class="n">scaler</span><span class="o">.</span><span class="n">save</span><span class="p">(</span><span class="n">save_path</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">def</span> <span class="nf">_run_PCA</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">variable_array</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Runs Principal Component Analysis (PCA) on the given variable array.</span>

<span class="sd">        Args:</span>
<span class="sd">            variable_array (array-like): The input array containing the variables.</span>
<span class="sd">            num_pcs (int, optional): The number of principal components to keep.</span>
<span class="sd">                If not specified, all components will be kept.</span>

<span class="sd">        Returns:</span>
<span class="sd">            tuple: A tuple containing the fitted PCA model and the transformed array.</span>

<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_pcs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">num_pcs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;num_pcs must be an integer, float, or string ending with &#39;%&#39;&quot;</span><span class="p">)</span>

        <span class="c1"># if num_pcs is a string, convert it to a float</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">num_pcs</span><span class="p">,</span> <span class="nb">str</span><span class="p">)</span> <span class="ow">and</span> <span class="n">num_pcs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
            <span class="n">num_pcs</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_pcs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">num_pcs</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">num_pcs</span> <span class="o">/=</span> <span class="mi">100</span>

        <span class="c1"># run PCA</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">PCA</span><span class="p">(</span>
            <span class="n">n_components</span><span class="o">=</span><span class="n">num_pcs</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="c1"># fit and transform the variable array</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">fit</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>
        <span class="n">pca_array</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">variable_array</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">pca</span><span class="p">,</span> <span class="n">pca_array</span>

    <span class="k">def</span> <span class="nf">_load_pca_models</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pca_model_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>
        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="n">pca_model_directory</span>

        <span class="c1"># get all pca model paths</span>
        <span class="n">pca_models_paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">)</span>
        <span class="n">pca_models_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;pca&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># load pca models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="s2">&quot;evspsbl_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mrro_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pr_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smb_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;salinity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sle&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable name </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">evspsbl_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;evspsbl&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mrro_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;mrro&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pr_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;pr&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">smb_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;smb&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ts_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;ts&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thermal_forcing_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">salinity_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">temperature_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sle_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;sle&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">pca_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">evspsbl_anomaly</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">evspsbl_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">mrro_anomaly</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mrro_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">pr_anomaly</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pr_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">smb_anomaly</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">smb_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">ts_anomaly</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ts_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">thermal_forcing</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">thermal_forcing_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">salinity_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">temperature_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">sle</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sle_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pca_models</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">model_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pca_models</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aST&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aSMB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin_runoff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sle&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable name </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">aSMB_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;aSMB&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aST_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;aST&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">basin_runoff_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;basin_runoff&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thermal_forcing_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">pca_models</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">aSMB</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">aSMB_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">aST</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">aST_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">basin_runoff</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">basin_runoff_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">thermal_forcing</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">thermal_forcing_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">sle</span><span class="o">=</span><span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sle_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pca_models</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">model_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">pca_models_paths</span> <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pca_models</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">PCA</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">model_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">pca_models</span>

    <span class="k">def</span> <span class="nf">_load_scalers</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scaler_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="s2">&quot;all&quot;</span><span class="p">,</span> <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">):</span>

        <span class="k">if</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;standard&quot;</span><span class="p">:</span>
            <span class="n">scaler_class</span> <span class="o">=</span> <span class="n">StandardScaler</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;robust&quot;</span><span class="p">:</span>
            <span class="n">scaler_class</span> <span class="o">=</span> <span class="n">RobustScaler</span>
        <span class="k">elif</span> <span class="n">scaling_method</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;log&quot;</span><span class="p">:</span>
            <span class="n">scaler_class</span> <span class="o">=</span> <span class="n">LogScaler</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Scaler method </span><span class="si">{</span><span class="n">scaling_method</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">scaler_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="s2">&quot;self.scaler_directory is None, resorting to using self.pca_model_directory&quot;</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="s2">&quot;Scaler directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span>
        <span class="k">if</span> <span class="n">scaler_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="n">scaler_directory</span>

        <span class="c1"># get all scaler model paths</span>
        <span class="n">scaler_paths</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">)</span>
        <span class="n">scaler_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;scaler&quot;</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

        <span class="c1"># load scaler models</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="s2">&quot;evspsbl_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mrro_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;pr_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;smb_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;ts_anomaly&quot;</span><span class="p">,</span>
                <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;salinity&quot;</span><span class="p">,</span>
                <span class="s2">&quot;temperature&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sle&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable name </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">evspsbl_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;evspsbl&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">mrro_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;mrro&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">pr_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;pr&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">smb_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;smb&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">ts_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;ts&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thermal_forcing_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">salinity_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">temperature_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sle_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;sle&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">scalers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">evspsbl_anomaly</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">evspsbl_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">mrro_anomaly</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">mrro_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">pr_anomaly</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">pr_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">smb_anomaly</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">smb_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">ts_anomaly</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ts_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">thermal_forcing</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">thermal_forcing_model</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="p">),</span>
                    <span class="n">salinity</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">salinity_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">temperature</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">temperature_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                    <span class="n">sle</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sle_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">scaler_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scalers</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">scaler_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>  <span class="c1"># GrIS</span>
            <span class="k">if</span> <span class="n">var_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;all&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aST&quot;</span><span class="p">,</span>
                <span class="s2">&quot;aSMB&quot;</span><span class="p">,</span>
                <span class="s2">&quot;basin_runoff&quot;</span><span class="p">,</span>
                <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sle&quot;</span><span class="p">,</span>
                <span class="kc">None</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Variable name </span><span class="si">{</span><span class="n">var_name</span><span class="si">}</span><span class="s2"> not recognized.&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">var_name</span> <span class="o">==</span> <span class="s2">&quot;all&quot;</span> <span class="ow">or</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">aSMB_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;aSMB&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">aST_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;aST&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">basin_runoff_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;basin_runoff&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">thermal_forcing_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sle_model</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="s2">&quot;sle&quot;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

                <span class="n">scalers</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
                    <span class="n">aSMB</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">aSMB_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">aST</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">aST_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">basin_runoff</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">basin_runoff_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">thermal_forcing</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">thermal_forcing_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                    <span class="n">sle</span><span class="o">=</span><span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">sle_model</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="p">),</span>
                <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">scalers</span> <span class="o">=</span> <span class="p">{}</span>
                <span class="n">scaler_path</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">scaler_paths</span> <span class="k">if</span> <span class="n">var_name</span> <span class="ow">in</span> <span class="n">x</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">scalers</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">scaler_class</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">scaler_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">scalers</span>

<div class="viewcode-block" id="DimensionalityReducer.transform">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer.transform">[docs]</a>
    <span class="k">def</span> <span class="nf">transform</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">x</span><span class="p">,</span>
        <span class="n">var_name</span><span class="p">,</span>
        <span class="n">num_pcs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">pca_model_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scaler_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">scaling_method</span><span class="o">=</span><span class="s2">&quot;standard&quot;</span><span class="p">,</span>
    <span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Transform the given variable into PCA space.</span>

<span class="sd">        Args:</span>
<span class="sd">            x (array-like): The input array containing the variables.</span>
<span class="sd">            variable (str): The name of the variable to transform.</span>
<span class="sd">            pca_models_paths (dict): A dictionary containing the filepaths for the PCA models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array-like: The transformed array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#</span>
        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="n">pca_model_directory</span>

        <span class="k">if</span> <span class="n">scaler_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">scaler_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span> <span class="o">=</span> <span class="n">scaler_directory</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">x</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># load pca and scaler models</span>
        <span class="n">pca_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_pca_models</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">scalers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_scalers</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scaler_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">,</span> <span class="n">scaling_method</span><span class="o">=</span><span class="n">scaling_method</span>
        <span class="p">)</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">pca_models</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">scalers</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>

        <span class="c1"># scale and transform</span>
        <span class="n">scaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
        <span class="n">transformed</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">transform</span><span class="p">(</span><span class="n">scaled</span><span class="p">)</span>

        <span class="c1"># if num_pcs is a string, convert it to a float</span>
        <span class="k">if</span> <span class="n">num_pcs</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">num_pcs</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">):</span>
            <span class="n">exp_var_pca</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">explained_variance_ratio_</span>
            <span class="n">cum_sum_eigenvalues</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">cumsum</span><span class="p">(</span><span class="n">exp_var_pca</span><span class="p">)</span>
            <span class="n">num_pcs_cutoff</span> <span class="o">=</span> <span class="n">cum_sum_eigenvalues</span> <span class="o">&gt;</span> <span class="nb">float</span><span class="p">(</span><span class="n">num_pcs</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;%&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="o">/</span> <span class="mi">100</span>
            <span class="k">if</span> <span class="o">~</span><span class="n">num_pcs_cutoff</span><span class="o">.</span><span class="n">any</span><span class="p">():</span>
                <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Explained variance cutoff (</span><span class="si">{</span><span class="n">num_pcs</span><span class="si">}</span><span class="s2">) not reached, using all PCs available (</span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">cum_sum_eigenvalues</span><span class="p">)</span><span class="si">}</span><span class="s2">).&quot;</span>
                <span class="p">)</span>
                <span class="n">num_pcs</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cum_sum_eigenvalues</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">num_pcs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">num_pcs_cutoff</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="k">return</span> <span class="n">transformed</span><span class="p">[:,</span> <span class="p">:</span><span class="n">num_pcs</span><span class="p">]</span></div>


<div class="viewcode-block" id="DimensionalityReducer.invert">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DimensionalityReducer.invert">[docs]</a>
    <span class="k">def</span> <span class="nf">invert</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pca_x</span><span class="p">,</span> <span class="n">var_name</span><span class="p">,</span> <span class="n">pca_model_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">scaler_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Invert the given variable from PCA space.</span>

<span class="sd">        Args:</span>
<span class="sd">            pca_x (array-like): The input array containing the variables in PCA space.</span>
<span class="sd">            variable (str): The name of the variable to transform.</span>
<span class="sd">            pca_models_paths (dict): A dictionary containing the filepaths for the PCA models.</span>

<span class="sd">        Returns:</span>
<span class="sd">            array-like: The inverted array.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="s2">&quot;PCA model directory must be specified, or DimensionalityReducer.generate_pca_models must be run first.&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="n">pca_model_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">pca_model_directory</span> <span class="o">=</span> <span class="n">pca_model_directory</span>

        <span class="c1"># load pca and calculate inverse</span>
        <span class="n">pca_models</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_pca_models</span><span class="p">(</span><span class="n">pca_model_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">pca</span> <span class="o">=</span> <span class="n">pca_models</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">inverted</span> <span class="o">=</span> <span class="n">pca</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">pca_x</span><span class="p">)</span>

        <span class="c1"># unscale pca inverse</span>
        <span class="n">scalers</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_scalers</span><span class="p">(</span><span class="n">scaler_directory</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="n">var_name</span><span class="p">)</span>
        <span class="n">scaler</span> <span class="o">=</span> <span class="n">scalers</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span>
        <span class="n">unscaled</span> <span class="o">=</span> <span class="n">scaler</span><span class="o">.</span><span class="n">inverse_transform</span><span class="p">(</span><span class="n">inverted</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">unscaled</span></div>
</div>



<div class="viewcode-block" id="get_xarray_data">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.get_xarray_data">[docs]</a>
<span class="k">def</span> <span class="nf">get_xarray_data</span><span class="p">(</span><span class="n">dataset_fp</span><span class="p">,</span> <span class="n">var_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="s2">&quot;AIS&quot;</span><span class="p">,</span> <span class="n">convert_and_subset</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Retrieves data from an xarray dataset.</span>

<span class="sd">    Args:</span>
<span class="sd">        dataset_fp (str): The file path to the xarray dataset.</span>
<span class="sd">        var_name (str, optional): The name of the variable to retrieve from the dataset. Defaults to None.</span>
<span class="sd">        ice_sheet (str, optional): The ice sheet type. Defaults to &#39;AIS&#39;.</span>
<span class="sd">        convert_and_subset (bool, optional): Flag indicating whether to convert and subset the dataset. Defaults to False.</span>

<span class="sd">    Returns:</span>
<span class="sd">        np.ndarray or xr.Dataset: The retrieved data from the dataset.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
        <span class="n">dataset_fp</span><span class="p">,</span>
        <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">engine</span><span class="o">=</span><span class="s2">&quot;netcdf4&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="s2">&quot;ivaf&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">variables</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">else</span><span class="p">:</span>

        <span class="c1"># handle extra dimensions and variables</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;nv4&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span>
            <span class="s2">&quot;z_bnds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
            <span class="s2">&quot;mapping&quot;</span><span class="p">,</span>
            <span class="s2">&quot;time_bounds&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lat2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;lon2d&quot;</span><span class="p">,</span>
            <span class="s2">&quot;polar_stereographic&quot;</span><span class="p">,</span>
        <span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># subset the dataset for 5km resolution (GrIS)</span>
    <span class="k">if</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1681</span> <span class="ow">and</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2881</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">])</span>

    <span class="k">if</span> <span class="n">convert_and_subset</span><span class="p">:</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">var_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">values</span>
        <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">x_dim</span> <span class="o">=</span> <span class="mi">761</span> <span class="k">if</span> <span class="n">ice_sheet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ais&quot;</span> <span class="k">else</span> <span class="mi">337</span>
        <span class="n">y_dim</span> <span class="o">=</span> <span class="mi">761</span> <span class="k">if</span> <span class="n">ice_sheet</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ais&quot;</span> <span class="k">else</span> <span class="mi">577</span>
        <span class="k">if</span> <span class="p">(</span>
            <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span>
            <span class="ow">or</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span>
            <span class="ow">or</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="n">y_dim</span> <span class="ow">and</span> <span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="n">x_dim</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">pass</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># TODO: fix this. this is just a weird way of tranposing, not sure if it even happens.</span>
            <span class="n">grid_indices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])[</span>
                <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">x_dim</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="n">y_dim</span><span class="p">)</span>
            <span class="p">]</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">moveaxis</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="nb">list</span><span class="p">(</span><span class="n">grid_indices</span><span class="p">),</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">])</span>

        <span class="k">if</span> <span class="s2">&quot;time&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span>
                <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">data_flattened</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data_flattened</span>

    <span class="k">return</span> <span class="n">dataset</span></div>



<div class="viewcode-block" id="DatasetMerger">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DatasetMerger">[docs]</a>
<span class="k">class</span> <span class="nc">DatasetMerger</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    A class for merging datasets from forcing and projection files.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="p">,</span> <span class="n">forcings</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">experiment_file</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Initializes a DatasetMerger object.</span>

<span class="sd">        Args:</span>
<span class="sd">            ice_sheet (str): The ice sheet name.</span>
<span class="sd">            forcing_dir (str): The directory path for forcing files.</span>
<span class="sd">            projection_dir (str): The directory path for projection files.</span>
<span class="sd">            experiment_file (str): The path to the experiment file (CSV or JSON).</span>
<span class="sd">            output_dir (str): The directory path to save the merged dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">=</span> <span class="n">ice_sheet</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcings</span> <span class="o">=</span> <span class="n">forcings</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projections</span> <span class="o">=</span> <span class="n">projections</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiment_file</span> <span class="o">=</span> <span class="n">experiment_file</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span> <span class="o">=</span> <span class="n">output_dir</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiment_file</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">ice_sheet</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
        <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiment_file</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.json&quot;</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_json</span><span class="p">(</span><span class="n">experiment_file</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Experiment file must be a CSV or JSON file.&quot;</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">forcings</span><span class="p">,</span>
            <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span>
            <span class="n">path</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">projections</span><span class="p">,</span>
            <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;csv&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">forcing_metadata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_forcing_metadata</span><span class="p">()</span>

<div class="viewcode-block" id="DatasetMerger.merge_dataset">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DatasetMerger.merge_dataset">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_dataset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Merges the forcing and projection files and creates a dataset.</span>

<span class="sd">        Returns:</span>
<span class="sd">            int: Returns 0 after successfully merging and saving the dataset.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>

        <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">projection</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span>
            <span class="n">tqdm</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">,</span>
                <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">projection_paths</span><span class="p">),</span>
                <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Merging forcing &amp; projection files&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">):</span>
            <span class="c1"># get experiment from projection filepath</span>
            <span class="n">exp</span> <span class="o">=</span> <span class="n">projection</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># make sure cases match when doing table lookup</span>

            <span class="c1"># get AOGCM value from table lookup</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">aogcm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                    <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="n">exp</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span><span class="o">.</span><span class="n">lower</span><span class="p">())</span>
                <span class="p">][</span><span class="s2">&quot;AOGCM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">except</span> <span class="ne">IndexError</span><span class="p">:</span>
                <span class="n">aogcm</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">experiments</span><span class="o">.</span><span class="n">exp</span> <span class="o">==</span> <span class="n">exp</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="s2">&quot;AOGCM&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">proj_pathway</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># names of CMIP models are slightly different, adjust based on AIS/GrIS directories</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proj_cmip_model</span> <span class="o">==</span> <span class="s2">&quot;csiro-mk3.6&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;csiro-mk3-6-0&quot;</span>
                <span class="k">elif</span> <span class="n">proj_cmip_model</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5-mr&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;ipsl-cm5a-mr&quot;</span>
                <span class="k">elif</span> <span class="n">proj_cmip_model</span> <span class="o">==</span> <span class="s2">&quot;cnrm-esm2&quot;</span> <span class="ow">or</span> <span class="n">proj_cmip_model</span> <span class="o">==</span> <span class="s2">&quot;cnrm-cm6&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">proj_cmip_model</span><span class="si">}</span><span class="s2">-1&quot;</span>
            <span class="k">elif</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;GrIS&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">proj_cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;noresm1-m&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;noresm1&quot;</span>
                <span class="k">elif</span> <span class="n">proj_cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5-mr&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;ipsl-cm5&quot;</span>
                <span class="k">elif</span> <span class="n">proj_cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;access1-3&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;access1.3&quot;</span>
                <span class="k">elif</span> <span class="n">proj_cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ukesm1-0-ll&quot;</span><span class="p">:</span>
                    <span class="n">proj_cmip_model</span> <span class="o">=</span> <span class="s2">&quot;ukesm1-cm6&quot;</span>

            <span class="c1"># get forcing file from table lookup that matches projection</span>
            <span class="n">forcing_files</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_metadata</span><span class="o">.</span><span class="n">file</span><span class="o">.</span><span class="n">loc</span><span class="p">[</span>
                <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_metadata</span><span class="o">.</span><span class="n">cmip_model</span> <span class="o">==</span> <span class="n">proj_cmip_model</span><span class="p">)</span>
                <span class="o">&amp;</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">forcing_metadata</span><span class="o">.</span><span class="n">pathway</span> <span class="o">==</span> <span class="n">proj_pathway</span><span class="p">)</span>
            <span class="p">]</span>

            <span class="k">if</span> <span class="n">forcing_files</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">IndexError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Could not find forcing file for </span><span class="si">{</span><span class="n">aogcm</span><span class="si">}</span><span class="s2">. Check formatting of experiment file.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">forcing_files</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">()</span>
                <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">forcing_files</span><span class="o">.</span><span class="n">values</span><span class="p">:</span>
                    <span class="n">forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
                        <span class="p">[</span><span class="n">forcings</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forcings</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
                    <span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">forcing_file</span> <span class="o">=</span> <span class="n">forcing_files</span><span class="o">.</span><span class="n">values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">forcings</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">forcing_file</span><span class="si">}</span><span class="s2">.csv&quot;</span><span class="p">)</span>

            <span class="c1"># load forcing and projection datasets</span>
            <span class="n">projections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">projection</span><span class="p">)</span>
            <span class="c1"># if forcings are longer than projections, cut off the beginning of the forcings</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">forcings</span><span class="p">)</span> <span class="o">&gt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">projections</span><span class="p">):</span>
                <span class="n">forcings</span> <span class="o">=</span> <span class="n">forcings</span><span class="o">.</span><span class="n">iloc</span><span class="p">[</span><span class="o">-</span><span class="nb">len</span><span class="p">(</span><span class="n">projections</span><span class="p">)</span> <span class="p">:]</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="c1"># add forcings and projections together and add some metadata</span>
            <span class="n">merged_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">forcings</span><span class="p">,</span> <span class="n">projections</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">merged_dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">merged_dataset</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">merged_dataset</span><span class="p">[</span><span class="s2">&quot;cmip_model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_cmip_model</span>
            <span class="n">merged_dataset</span><span class="p">[</span><span class="s2">&quot;pathway&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">proj_pathway</span>
            <span class="n">merged_dataset</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
            <span class="n">merged_dataset</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">i</span>

            <span class="c1"># now add to dataset with all forcing/projection pairs</span>
            <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">full_dataset</span><span class="p">,</span> <span class="n">merged_dataset</span><span class="p">])</span>

        <span class="c1"># save the full dataset</span>
        <span class="n">full_dataset</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">/dataset.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">return</span> <span class="mi">0</span></div>


<div class="viewcode-block" id="DatasetMerger.merge_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.DatasetMerger.merge_sectors">[docs]</a>
    <span class="k">def</span> <span class="nf">merge_sectors</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">forcings_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">projections_file</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">save_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

        <span class="k">pass</span></div>


    <span class="c1"># def merge(self, inputs=&#39;pca&#39;, outputs=&#39;sectors&#39;, save_dir=None):</span>
    <span class="c1">#     if save_dir is None:</span>
    <span class="c1">#         save_dir = self.output_dir</span>

    <span class="c1">#     full_dataset = pd.DataFrame()</span>
    <span class="c1">#     self.experiments[&#39;exp&#39;] = self.experiments[&#39;exp&#39;].apply(lambda x: x.lower())</span>

    <span class="c1">#     if outputs.lower() == &#39;average&#39; or outputs.lower() == &#39;sectors&#39;:</span>
    <span class="c1">#         paths = get_all_filepaths(path=self.projection_dir, filetype=&#39;nc&#39;, contains=&#39;rm&#39;, not_contains=&#39;historical&#39;)</span>
    <span class="c1">#         paths = [x for x in paths if &#39;ctrl&#39; not in x]</span>

    <span class="c1">#     for i, projection in enumerate(tqdm(paths, total=len(paths), desc=&quot;Merging forcing &amp; projection files&quot;)):</span>
    <span class="c1">#         # get experiment from projection filepath</span>

    <span class="c1">#         exp = projection.replace(&#39;.nc&#39;, &#39;&#39;).replace(&#39;.csv&#39;, &#39;&#39;).split(&#39;/&#39;)[-1].split(&#39;_&#39;)[-1]</span>

    <span class="c1">#         # make sure cases match when doing table lookup</span>

    <span class="c1">#         # get AOGCM value from table lookup</span>
    <span class="c1">#         try:</span>
    <span class="c1">#             aogcm = self.experiments.loc[(self.experiments.exp == exp.lower()) &amp; (self.experiments.ice_sheet ==self.ice_sheet.lower())][&#39;AOGCM&#39;].values[0]</span>
    <span class="c1">#         except IndexError:</span>
    <span class="c1">#             aogcm = self.experiments.loc[self.experiments.exp == exp.lower()][&#39;AOGCM&#39;].values[0]</span>
    <span class="c1">#         proj_cmip_model = aogcm.split(&#39;_&#39;)[0]</span>
    <span class="c1">#         proj_pathway = aogcm.split(&#39;_&#39;)[-1]</span>

    <span class="c1">#         # names of CMIP models are slightly different, adjust based on AIS/GrIS directories</span>
    <span class="c1">#         if self.ice_sheet == &#39;AIS&#39;:</span>
    <span class="c1">#             if proj_cmip_model == &#39;csiro-mk3.6&#39;:</span>
    <span class="c1">#                 proj_cmip_model = &#39;csiro-mk3-6-0&#39;</span>
    <span class="c1">#             elif proj_cmip_model == &#39;ipsl-cm5-mr&#39;:</span>
    <span class="c1">#                 proj_cmip_model = &#39;ipsl-cm5a-mr&#39;</span>
    <span class="c1">#             elif proj_cmip_model == &#39;cnrm-esm2&#39; or proj_cmip_model == &#39;cnrm-cm6&#39;:</span>
    <span class="c1">#                 proj_cmip_model = f&#39;{proj_cmip_model}-1&#39;</span>
    <span class="c1">#         elif self.ice_sheet == &#39;GrIS&#39;:</span>
    <span class="c1">#             if proj_cmip_model.lower() == &#39;noresm1-m&#39;:</span>
    <span class="c1">#                 proj_cmip_model = &#39;noresm1&#39;</span>
    <span class="c1">#             elif proj_cmip_model.lower() == &#39;ipsl-cm5-mr&#39;:</span>
    <span class="c1">#                 proj_cmip_model = &#39;ipsl-cm5&#39;</span>
    <span class="c1">#             elif proj_cmip_model.lower() == &#39;access1-3&#39;:</span>
    <span class="c1">#                 proj_cmip_model = &#39;access1&#39;</span>

    <span class="c1">#                     # get forcing file from table lookup that matches projection</span>
    <span class="c1">#         forcing_files = self.forcing_metadata.file.loc[(self.forcing_metadata.cmip_model == proj_cmip_model) &amp; (self.forcing_metadata.pathway == proj_pathway)]</span>

    <span class="c1">#         if forcing_files.empty:</span>
    <span class="c1">#             raise IndexError(f&quot;Could not find forcing file for {aogcm}. Check formatting of experiment file.&quot;)</span>

    <span class="c1">#         if len(forcing_files) &gt; 1:</span>
    <span class="c1">#             forcings = pd.DataFrame()</span>
    <span class="c1">#             for file in forcing_files.values:</span>
    <span class="c1">#                 forcings = pd.concat([forcings, pd.read_csv(f&quot;{self.forcing_dir}/{file}.csv&quot;)], axis=1)</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             forcing_file = forcing_files.values[0]</span>
    <span class="c1">#             forcings = pd.read_csv(f&quot;{self.forcing_dir}/{forcing_file}.csv&quot;)</span>

    <span class="c1">#         # load forcing and projection datasets</span>
    <span class="c1">#         if &#39;nc&#39; in projection:</span>
    <span class="c1">#             projections = xr.open_dataset(projection)</span>
    <span class="c1">#             projections = projections.to_dataframe()</span>
    <span class="c1">#             projections = projections[[x for x in projections.columns if &#39;ivaf&#39; in x]]</span>
    <span class="c1">#             projections = projections / 1e9 / 362.5</span>
    <span class="c1">#         else:</span>
    <span class="c1">#             projections = pd.read_csv(projection)</span>

    <span class="c1">#         # if forcings are longer than projections, cut off the beginning of the forcings</span>
    <span class="c1">#         if len(forcings) &gt; len(projections):</span>
    <span class="c1">#             forcings = forcings.iloc[-len(projections):].reset_index(drop=True)</span>

    <span class="c1">#          # add forcings and projections together and add some metadata</span>
    <span class="c1">#         merged_dataset = pd.concat([forcings, projections], axis=1)</span>
    <span class="c1">#         merged_dataset[&#39;cmip_model&#39;] = proj_cmip_model</span>
    <span class="c1">#         merged_dataset[&#39;pathway&#39;] = proj_pathway</span>
    <span class="c1">#         merged_dataset[&#39;exp&#39;] = exp</span>
    <span class="c1">#         merged_dataset[&#39;id&#39;] = i</span>

    <span class="c1">#         # now add to dataset with all forcing/projection pairs</span>
    <span class="c1">#         full_dataset = pd.concat([full_dataset, merged_dataset])</span>

    <span class="c1">#     # save the full dataset</span>
    <span class="c1">#     full_dataset.to_csv(f&quot;{self.output_dir}/dataset.csv&quot;, index=False)</span>

    <span class="k">def</span> <span class="nf">_get_forcing_metadata</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Retrieves the metadata for the forcing files.</span>

<span class="sd">        Returns:</span>
<span class="sd">            df (pandas.DataFrame): DataFrame containing the metadata for the forcing files.</span>
<span class="sd">                The DataFrame has three columns: &#39;file&#39;, &#39;cmip_model&#39;, and &#39;pathway&#39;.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">pairs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="c1"># loop through forcings, looking for cmip model and pathway</span>
        <span class="k">for</span> <span class="n">forcing</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">forcing_paths</span><span class="p">:</span>
            <span class="k">if</span> <span class="p">(</span>
                <span class="n">forcing</span>
                <span class="o">==</span> <span class="sa">r</span><span class="s2">&quot;/oscar/home/pvankatw/scratch/pca/AIS/forcings/PCA_IPSL-CM5A-MR_RCP26_salinity_8km_x_60m.csv&quot;</span>
            <span class="p">):</span>
                <span class="n">stop</span> <span class="o">=</span> <span class="s2">&quot;stop&quot;</span>
            <span class="n">forcing</span> <span class="o">=</span> <span class="n">forcing</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.csv&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">cmip_model</span> <span class="o">=</span> <span class="n">forcing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>

            <span class="c1"># GrIS has MAR3.9 in name, ignore</span>
            <span class="k">if</span> <span class="n">cmip_model</span> <span class="o">==</span> <span class="s2">&quot;MAR3.9&quot;</span><span class="p">:</span>
                <span class="n">cmip_model</span> <span class="o">=</span> <span class="n">forcing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;gris&quot;</span><span class="p">:</span>
                <span class="n">cmip_model</span> <span class="o">=</span> <span class="n">forcing</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="s2">&quot;rcp&quot;</span> <span class="ow">in</span> <span class="n">forcing</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="ow">or</span> <span class="s2">&quot;ssp&quot;</span> <span class="ow">in</span> <span class="n">forcing</span><span class="o">.</span><span class="n">lower</span><span class="p">():</span>
                <span class="k">for</span> <span class="n">substring</span> <span class="ow">in</span> <span class="n">forcing</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="s2">&quot;rcp&quot;</span> <span class="ow">in</span> <span class="n">substring</span> <span class="ow">or</span> <span class="s2">&quot;ssp&quot;</span> <span class="ow">in</span> <span class="n">substring</span><span class="p">:</span>
                        <span class="n">pathway</span> <span class="o">=</span> <span class="n">substring</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">1</span> <span class="ow">and</span> <span class="p">(</span>
                            <span class="s2">&quot;rcp&quot;</span> <span class="ow">in</span> <span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="ow">or</span> <span class="s2">&quot;ssp&quot;</span> <span class="ow">in</span> <span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="p">):</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">2</span><span class="p">:</span>
                                <span class="n">cmip_model</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">:</span><span class="mi">2</span><span class="p">])</span>
                                <span class="n">pathway</span> <span class="o">=</span> <span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">cmip_model</span> <span class="o">=</span> <span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                                <span class="n">pathway</span> <span class="o">=</span> <span class="n">pathway</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
                        <span class="k">break</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">pathway</span> <span class="o">=</span> <span class="s2">&quot;rcp85&quot;</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;GrIS&quot;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;noresm1-m&quot;</span><span class="p">:</span>
                    <span class="n">cmip_model</span> <span class="o">=</span> <span class="s2">&quot;noresm1&quot;</span>
                <span class="k">elif</span> <span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5-mr&quot;</span><span class="p">:</span>
                    <span class="n">cmip_model</span> <span class="o">=</span> <span class="s2">&quot;ipsl-cm5&quot;</span>
                <span class="k">elif</span> <span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;access1-3&quot;</span><span class="p">:</span>
                    <span class="n">cmip_model</span> <span class="o">=</span> <span class="s2">&quot;access1.3&quot;</span>
                <span class="k">elif</span> <span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="o">==</span> <span class="s2">&quot;ukesm1-0-ll&quot;</span><span class="p">:</span>
                    <span class="n">cmip_model</span> <span class="o">=</span> <span class="s2">&quot;ukesm1-cm6&quot;</span>

            <span class="n">pairs</span><span class="p">[</span><span class="n">forcing</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="n">cmip_model</span><span class="o">.</span><span class="n">lower</span><span class="p">(),</span> <span class="n">pathway</span><span class="o">.</span><span class="n">lower</span><span class="p">()]</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">(</span><span class="n">pairs</span><span class="p">)</span><span class="o">.</span><span class="n">T</span><span class="o">.</span><span class="n">reset_index</span><span class="p">()</span>
        <span class="n">df</span><span class="o">.</span><span class="n">columns</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;file&quot;</span><span class="p">,</span> <span class="s2">&quot;cmip_model&quot;</span><span class="p">,</span> <span class="s2">&quot;pathway&quot;</span><span class="p">]</span>

        <span class="k">return</span> <span class="n">df</span></div>



<div class="viewcode-block" id="combine_gris_forcings">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.combine_gris_forcings">[docs]</a>
<span class="k">def</span> <span class="nf">combine_gris_forcings</span><span class="p">(</span><span class="n">forcing_dir</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Combine GrIS forcings from multiple CMIP directories into a single NetCDF file.</span>

<span class="sd">    Parameters:</span>
<span class="sd">    - forcing_dir (str): The directory containing the GrIS forcings.</span>

<span class="sd">    Returns:</span>
<span class="sd">    - int: 0 indicating successful completion of the function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">atmosphere_dir</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_dir</span><span class="si">}</span><span class="s2">/GrIS/Atmosphere_Forcing/aSMB_observed/v1/&quot;</span>
    <span class="n">cmip_directories</span> <span class="o">=</span> <span class="nb">next</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">walk</span><span class="p">(</span><span class="n">atmosphere_dir</span><span class="p">))[</span><span class="mi">1</span><span class="p">]</span>
    <span class="k">for</span> <span class="n">cmip_dir</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span>
        <span class="n">cmip_directories</span><span class="p">,</span> <span class="n">total</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">cmip_directories</span><span class="p">),</span> <span class="n">desc</span><span class="o">=</span><span class="s2">&quot;Processing CMIP directories&quot;</span>
    <span class="p">):</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;aSMB&quot;</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;aST&quot;</span><span class="p">]:</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atmosphere_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cmip_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">files</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">)])</span>
            <span class="n">years</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">files</span><span class="p">])</span>
            <span class="n">year_files</span> <span class="o">=</span> <span class="n">files</span><span class="p">[(</span><span class="n">years</span> <span class="o">&gt;=</span> <span class="mi">2015</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">years</span> <span class="o">&lt;=</span> <span class="mi">2100</span><span class="p">)]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">file</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">year_files</span><span class="p">):</span>
                <span class="c1"># first iteration, open dataset and store</span>
                <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atmosphere_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cmip_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nv&quot;</span><span class="p">,</span> <span class="s2">&quot;nv4&quot;</span><span class="p">,</span> <span class="s2">&quot;mapping&quot;</span><span class="p">]:</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;mapping&quot;</span><span class="p">)</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">dataset</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">])</span>
                    <span class="k">continue</span>

                <span class="c1"># following iterations, open dataset and concatenate</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">atmosphere_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">cmip_dir</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">dim</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;nv&quot;</span><span class="p">,</span> <span class="s2">&quot;nv4&quot;</span><span class="p">]:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="n">dim</span><span class="p">)</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="k">pass</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="s2">&quot;mapping&quot;</span><span class="p">)</span>
                <span class="n">data</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">])</span>
                <span class="c1"># data[&#39;time&#39;] = pd.to_datetime(year, format=&#39;%Y&#39;)</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">dataset</span><span class="p">,</span> <span class="n">data</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

            <span class="c1"># Now you have the dataset with the files loaded and time dimension set</span>
            <span class="n">dataset</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span>
                <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">atmosphere_dir</span><span class="p">,</span> <span class="n">cmip_dir</span><span class="p">,</span> <span class="sa">f</span><span class="s2">&quot;GrIS_</span><span class="si">{</span><span class="n">cmip_dir</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">var</span><span class="si">}</span><span class="s2">_combined.nc&quot;</span><span class="p">)</span>
            <span class="p">)</span>

    <span class="k">return</span> <span class="mi">0</span></div>



<div class="viewcode-block" id="process_GrIS_atmospheric_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_GrIS_atmospheric_sectors">[docs]</a>
<span class="k">def</span> <span class="nf">process_GrIS_atmospheric_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">):</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">path_to_forcings</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Atmosphere_Forcing/aSMB_observed/v1/&quot;</span>
    <span class="n">af_directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path_to_forcings</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcing_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">path_to_forcings</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">forcing_directory</span>
    <span class="p">)</span>

    <span class="c1"># check to see if GrIS forcings have been combined</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">af_directory</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filepaths</span><span class="p">:</span>
        <span class="n">combine_gris_forcings</span><span class="p">(</span><span class="n">af_directory</span><span class="p">)</span>
        <span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">af_directory</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">filepaths</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No combined files found. Check combine_gris_forcings function.&quot;</span><span class="p">)</span>

    <span class="n">aogcm_directories</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">af_directory</span><span class="p">)</span>
    <span class="n">aogcm_directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aogcm_directories</span> <span class="k">if</span> <span class="s2">&quot;DS_Store&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s2">&quot;README&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="n">sectors</span> <span class="o">=</span> <span class="n">_format_grid_file</span><span class="p">(</span><span class="n">grid_file</span><span class="p">)</span>
    <span class="n">unique_sectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aogcm_directories</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aogcm_directories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Directory: </span><span class="si">{</span><span class="n">fp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since start: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2"> minutes&quot;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">af_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;combined&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;There should only be 2 combined files in each firectory, see </span><span class="si">{</span><span class="n">fp</span><span class="si">}</span><span class="s2">.&quot;</span><span class="p">)</span>

        <span class="n">st_and_smb</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

            <span class="c1"># handle extra dimensions and variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;nv4&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;z_bnds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mapping&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_bounds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;polar_stereographic&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>

            <span class="n">formatted_aogcm</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">formatted_aogcm</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">formatted_aogcm</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>

            <span class="n">aogcm_data</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">unique_sectors</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sector</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">formatted_aogcm</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">aogcm_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_averages</span><span class="p">)</span>
            <span class="n">st_and_smb</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">))</span>

        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">st_and_smb</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span></div>



<div class="viewcode-block" id="process_AIS_atmospheric_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_AIS_atmospheric_sectors">[docs]</a>
<span class="k">def</span> <span class="nf">process_AIS_atmospheric_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">):</span>

    <span class="n">ice_sheet</span> <span class="o">=</span> <span class="s2">&quot;AIS&quot;</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">path_to_forcings</span> <span class="o">=</span> <span class="s2">&quot;/Atmosphere_Forcing/&quot;</span>
    <span class="n">af_directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path_to_forcings</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcing_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">path_to_forcings</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">forcing_directory</span>
    <span class="p">)</span>

    <span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">af_directory</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="s2">&quot;1995-2100&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="s2">&quot;8km&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    
    <span class="k">if</span> <span class="ow">not</span> <span class="n">filepaths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No files found. Check the path to the forcing files.&quot;</span><span class="p">)</span>

    <span class="n">sectors</span> <span class="o">=</span> <span class="n">_format_grid_file</span><span class="p">(</span><span class="n">grid_file</span><span class="p">)</span>
    <span class="n">unique_sectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">fp</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filepaths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File: </span><span class="si">{</span><span class="n">fp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since start: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2"> minutes&quot;</span><span class="p">)</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">fp</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">dataset</span><span class="p">)</span>

        <span class="c1"># handle extra dimensions and variables</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;nv4&quot;</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
            <span class="k">pass</span>

        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;z_bnds&quot;</span><span class="p">,</span> <span class="s2">&quot;lat&quot;</span><span class="p">,</span> <span class="s2">&quot;lon&quot;</span><span class="p">,</span> <span class="s2">&quot;mapping&quot;</span><span class="p">,</span> <span class="s2">&quot;time_bounds&quot;</span><span class="p">,</span> <span class="s2">&quot;lat2d&quot;</span><span class="p">,</span> <span class="s2">&quot;lon2d&quot;</span><span class="p">]:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="c1"># dataset = dataset.transpose(&quot;time&quot;, &quot;x&quot;, &quot;y&quot;, ...)</span>
        <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>

        <span class="n">aogcm_data</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">unique_sectors</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sector</span>
            <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                <span class="n">mask</span><span class="p">,</span>
            <span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">],</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
            <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
            <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
            <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">aogcm_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_averages</span><span class="p">)</span>

        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">))</span>
    <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span>
    <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="n">atmospheric_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">atmospheric_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
    <span class="k">return</span> <span class="n">atmospheric_df</span></div>



<div class="viewcode-block" id="process_AIS_oceanic_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_AIS_oceanic_sectors">[docs]</a>
<span class="k">def</span> <span class="nf">process_AIS_oceanic_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">):</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/Ocean_Forcing/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcing_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;Ocean_Forcing/&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">forcing_directory</span>
    <span class="p">)</span>
    <span class="c1"># Get all NC files that contain data from 1995-2100</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="n">directory</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="s2">&quot;1995-2100&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span> <span class="k">if</span> <span class="s2">&quot;8km&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>

    <span class="c1"># In the case of ocean forcings, use the filepaths of the files to determine</span>
    <span class="c1"># which directories need to be used for OceanForcing processing. Change to</span>
    <span class="c1"># those directories rather than individual files.</span>
    <span class="n">aogcms</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">]))</span>
    <span class="n">filepaths</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">aogcm</span><span class="si">}</span><span class="s2">/&quot;</span> <span class="k">for</span> <span class="n">aogcm</span> <span class="ow">in</span> <span class="n">aogcms</span><span class="p">]</span>

    <span class="c1"># Useful progress prints</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Files to be processed...&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">([</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">filepaths</span><span class="p">])</span>

    <span class="n">sectors</span> <span class="o">=</span> <span class="n">_format_grid_file</span><span class="p">(</span><span class="n">grid_file</span><span class="p">)</span>
    <span class="n">unique_sectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">directory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">filepaths</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">filepaths</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;File: </span><span class="si">{</span><span class="n">directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since start: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2"> minutes&quot;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/1995-2100/&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2"> does not contain 3 files.&quot;</span><span class="p">)</span>

        <span class="n">thermal_forcing_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;thermal_forcing&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">salinity_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;salinity&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">temperature_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;temperature&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">thermal_forcing</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/1995-2100/</span><span class="si">{</span><span class="n">thermal_forcing_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/1995-2100/</span><span class="si">{</span><span class="n">salinity_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/1995-2100/</span><span class="si">{</span><span class="n">temperature_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="n">thermal_forcing</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">thermal_forcing</span><span class="p">)</span>
        <span class="n">salinity</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">salinity</span><span class="p">)</span>
        <span class="n">temperature</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">temperature</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">:</span> <span class="n">thermal_forcing</span><span class="p">,</span>
            <span class="s2">&quot;salinity&quot;</span><span class="p">:</span> <span class="n">salinity</span><span class="p">,</span>
            <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="n">temperature</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">aogcm_data</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;thermal_forcing&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;salinity&quot;</span><span class="p">:</span> <span class="p">[],</span> <span class="s2">&quot;temperature&quot;</span><span class="p">:</span> <span class="p">[]}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># handle extra dimensions and variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;nv4&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;z_bnds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mapping&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_bounds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;polar_stereographic&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>

            <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">unique_sectors</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sector</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_AIS_ocean_aogcm_name</span><span class="p">(</span>
                    <span class="n">directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
                <span class="p">)</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">aogcm_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_averages</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">[</span><span class="s2">&quot;thermal_forcing&quot;</span><span class="p">]),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">[</span><span class="s2">&quot;salinity&quot;</span><span class="p">]),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">[</span><span class="s2">&quot;temperature&quot;</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span></div>



<div class="viewcode-block" id="process_GrIS_oceanic_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_GrIS_oceanic_sectors">[docs]</a>
<span class="k">def</span> <span class="nf">process_GrIS_oceanic_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">):</span>

    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">path_to_forcing</span> <span class="o">=</span> <span class="s2">&quot;Ocean_Forcing/Melt_Implementation/v4/&quot;</span>
    <span class="n">forcing_directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">path_to_forcing</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">forcing_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="n">path_to_forcing</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">forcing_directory</span>
    <span class="p">)</span>

    <span class="n">aogcm_directories</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">)</span>
    <span class="n">aogcm_directories</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">aogcm_directories</span> <span class="k">if</span> <span class="s2">&quot;DS_Store&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span> <span class="ow">and</span> <span class="s2">&quot;README&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>

    <span class="n">sectors</span> <span class="o">=</span> <span class="n">_format_grid_file</span><span class="p">(</span><span class="n">grid_file</span><span class="p">)</span>
    <span class="n">unique_sectors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">sectors</span><span class="p">)</span>
    <span class="n">all_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">directory</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">aogcm_directories</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="si">}</span><span class="s2"> / </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">aogcm_directories</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;Directory: </span><span class="si">{</span><span class="n">directory</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Time since start: </span><span class="si">{</span><span class="p">(</span><span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="w"> </span><span class="o">//</span><span class="w"> </span><span class="mi">60</span><span class="si">}</span><span class="s2"> minutes&quot;</span><span class="p">)</span>

        <span class="n">files</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">listdir</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">files</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Directory </span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2"> does not contain 2 files.&quot;</span><span class="p">)</span>

        <span class="n">thermal_forcing_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;thermalforcing&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">basin_runoff_file</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;basinrunoff&quot;</span> <span class="ow">in</span> <span class="n">f</span><span class="o">.</span><span class="n">lower</span><span class="p">()][</span><span class="mi">0</span><span class="p">]</span>

        <span class="n">thermal_forcing</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">thermal_forcing_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
        <span class="n">basin_runoff</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">forcing_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">basin_runoff_file</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>

        <span class="c1"># subset the dataset for 5km resolution (GrIS)</span>
        <span class="k">if</span> <span class="n">thermal_forcing</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1681</span> <span class="ow">and</span> <span class="n">thermal_forcing</span><span class="o">.</span><span class="n">dims</span><span class="p">[</span><span class="s2">&quot;y&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="mi">2881</span><span class="p">:</span>
            <span class="n">thermal_forcing</span> <span class="o">=</span> <span class="n">thermal_forcing</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">thermal_forcing</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">thermal_forcing</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">)</span>
            <span class="n">basin_runoff</span> <span class="o">=</span> <span class="n">basin_runoff</span><span class="o">.</span><span class="n">sel</span><span class="p">(</span>
                <span class="n">x</span><span class="o">=</span><span class="n">basin_runoff</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">basin_runoff</span><span class="o">.</span><span class="n">y</span><span class="o">.</span><span class="n">values</span><span class="p">[::</span><span class="mi">5</span><span class="p">]</span>
            <span class="p">)</span>

        <span class="n">thermal_forcing</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">thermal_forcing</span><span class="p">)</span>
        <span class="n">basin_runoff</span> <span class="o">=</span> <span class="n">convert_and_subset_times</span><span class="p">(</span><span class="n">basin_runoff</span><span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">:</span> <span class="n">thermal_forcing</span><span class="p">,</span>
            <span class="s2">&quot;basin_runoff&quot;</span><span class="p">:</span> <span class="n">basin_runoff</span><span class="p">,</span>
        <span class="p">}</span>
        <span class="n">aogcm_data</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;thermal_forcing&quot;</span><span class="p">:</span> <span class="p">[],</span>
            <span class="s2">&quot;basin_runoff&quot;</span><span class="p">:</span> <span class="p">[],</span>
        <span class="p">}</span>
        <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">dataset</span> <span class="ow">in</span> <span class="n">data</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># handle extra dimensions and variables</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop_dims</span><span class="p">(</span><span class="s2">&quot;nv4&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="p">[</span>
                <span class="s2">&quot;z_bnds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon&quot;</span><span class="p">,</span>
                <span class="s2">&quot;mapping&quot;</span><span class="p">,</span>
                <span class="s2">&quot;time_bounds&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lat2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;lon2d&quot;</span><span class="p">,</span>
                <span class="s2">&quot;polar_stereographic&quot;</span><span class="p">,</span>
            <span class="p">]:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">drop</span><span class="p">(</span><span class="n">labels</span><span class="o">=</span><span class="p">[</span><span class="n">var</span><span class="p">])</span>
                <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                    <span class="k">pass</span>
            <span class="k">if</span> <span class="s2">&quot;z&quot;</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">dims</span><span class="p">:</span>
                <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="s2">&quot;z&quot;</span><span class="p">,</span> <span class="n">skipna</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>
            <span class="k">except</span> <span class="ne">ValueError</span><span class="p">:</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
                <span class="n">dataset</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sectors</span>

            <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="n">unique_sectors</span><span class="p">:</span>
                <span class="n">mask</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">sector</span> <span class="o">==</span> <span class="n">sector</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">mask</span><span class="p">,</span> <span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">])</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_format_GrIS_ocean_aogcm_name</span><span class="p">(</span><span class="n">directory</span><span class="p">)</span>
                <span class="n">sector_averages</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
                <span class="n">sector_averages</span> <span class="o">=</span> <span class="n">sector_averages</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="n">aogcm_data</span><span class="p">[</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_averages</span><span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">[</span><span class="s2">&quot;thermal_forcing&quot;</span><span class="p">]),</span>
                <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">aogcm_data</span><span class="p">[</span><span class="s2">&quot;basin_runoff&quot;</span><span class="p">]),</span>
            <span class="p">],</span>
            <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">df</span> <span class="o">=</span> <span class="n">df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
        <span class="n">all_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">df</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_data</span><span class="p">)</span></div>



<span class="k">def</span> <span class="nf">_format_grid_file</span><span class="p">(</span><span class="n">grid_file</span><span class="p">):</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">grids</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">grid_file</span><span class="p">)</span>  <span class="c1"># .transpose(&#39;x&#39;, &#39;y&#39;,)</span>
        <span class="n">sector_name</span> <span class="o">=</span> <span class="s2">&quot;sectors&quot;</span> <span class="k">if</span> <span class="s2">&quot;8km&quot;</span> <span class="ow">in</span> <span class="n">grid_file</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;ID&quot;</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">grid_file</span><span class="p">,</span> <span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">):</span>
        <span class="n">sector_name</span> <span class="o">=</span> <span class="s2">&quot;ID&quot;</span> <span class="k">if</span> <span class="s2">&quot;Rignot&quot;</span> <span class="ow">in</span> <span class="n">grids</span><span class="o">.</span><span class="n">Description</span> <span class="k">else</span> <span class="s2">&quot;sectors&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;grid_file must be a string or an xarray Dataset.&quot;</span><span class="p">)</span>

    <span class="n">grids</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">expand_dims</span><span class="p">(</span><span class="n">dim</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">86</span><span class="p">})</span>
    <span class="n">sectors</span> <span class="o">=</span> <span class="n">grids</span><span class="p">[</span><span class="n">sector_name</span><span class="p">]</span>
    <span class="n">grids</span> <span class="o">=</span> <span class="n">grids</span><span class="o">.</span><span class="n">transpose</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="s2">&quot;y&quot;</span><span class="p">,</span> <span class="o">...</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">sectors</span>


<div class="viewcode-block" id="process_AIS_outputs">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_AIS_outputs">[docs]</a>
<span class="k">def</span> <span class="nf">process_AIS_outputs</span><span class="p">(</span>
    <span class="n">zenodo_directory</span><span class="p">,</span>
    <span class="n">with_ctrl</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>

    <span class="n">directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zenodo_directory</span><span class="si">}</span><span class="s2">/ComputedScalarsPaper/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zenodo_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;ComputedScalarsPaper&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">zenodo_directory</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">with_ctrl</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;ivaf_minus_ctrl_proj&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;ivaf_AIS&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">,</span> <span class="n">not_contains</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;hist&#39;</span><span class="p">,</span> <span class="s1">&#39;ctrl&#39;</span><span class="p">])</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">all_files_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">model</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">85</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not contain 86 years. Inserting a copy into the first year.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Copy the first entry</span>
            <span class="n">first_entry</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="c1"># Assuming numeric coordinates, create a new coordinate value</span>
            <span class="n">new_coord_value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">first_entry</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># Adjust this calculation based on your coordinate system</span>
            <span class="c1"># Set the new coordinate value for the copied entry</span>
            <span class="n">first_entry</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord_value</span>
            <span class="c1"># Concatenate the new entry with the original dataset</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">dataset</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="c1"># dataset = convert_and_subset_times(dataset)</span>
        <span class="n">all_sectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">19</span><span class="p">):</span>
            <span class="n">sector_x_data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="sa">f</span><span class="s2">&quot;ivaf_sector_</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="sa">f</span><span class="s2">&quot;ivaf_sector_</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">:</span> <span class="s2">&quot;ivaf&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">_sector</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">all_sectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_x_data</span><span class="p">)</span>
        <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_sectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">full_dataset</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
        <span class="n">full_dataset</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">all_files_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_files_data</span><span class="p">)</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;sle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;ivaf&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">362.5</span> <span class="o">/</span> <span class="mf">1e9</span>

    <span class="k">return</span> <span class="n">outputs</span></div>



<div class="viewcode-block" id="merge_datasets">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.merge_datasets">[docs]</a>
<span class="k">def</span> <span class="nf">merge_datasets</span><span class="p">(</span><span class="n">forcings</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">experiments_file</span><span class="p">,</span> <span class="n">ice_sheet</span><span class="o">=</span><span class="s2">&quot;AIS&quot;</span><span class="p">,</span> <span class="n">export_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>

    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiments_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">experiments_file</span><span class="p">)</span>
    <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">experiments_file</span><span class="p">,</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">):</span>
        <span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments_file</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;experiments_file must be a string or a pandas DataFrame.&quot;</span><span class="p">)</span>

    <span class="n">experiments</span> <span class="o">=</span> <span class="n">experiments</span><span class="p">[</span><span class="n">experiments</span><span class="o">.</span><span class="n">ice_sheet</span> <span class="o">==</span> <span class="n">ice_sheet</span><span class="p">]</span>
    <span class="n">projections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">projections</span><span class="p">,</span> <span class="n">experiments</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="s2">&quot;exp&quot;</span><span class="p">,</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>
    <span class="n">formatting_function</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">_format_AIS_forcings_aogcm_name</span> <span class="k">if</span> <span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span> <span class="k">else</span> <span class="n">_format_GrIS_forcings_aogcm_name</span>
    <span class="p">)</span>
    <span class="n">forcings</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forcings</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">apply</span><span class="p">(</span><span class="n">formatting_function</span><span class="p">)</span>
    <span class="n">projections</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;AOGCM&quot;</span><span class="p">:</span> <span class="s2">&quot;aogcm&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">forcings</span><span class="p">[</span><span class="s1">&#39;sector&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">forcings</span><span class="o">.</span><span class="n">sector</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span><span class="n">forcings</span><span class="p">,</span> <span class="n">projections</span><span class="p">,</span> <span class="n">on</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;aogcm&quot;</span><span class="p">,</span> <span class="s2">&quot;year&quot;</span><span class="p">,</span> <span class="s2">&quot;sector&quot;</span><span class="p">],</span> <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>



<div class="viewcode-block" id="process_GrIS_outputs">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_GrIS_outputs">[docs]</a>
<span class="k">def</span> <span class="nf">process_GrIS_outputs</span><span class="p">(</span>
    <span class="n">zenodo_directory</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">directory</span> <span class="o">=</span> <span class="p">(</span>
        <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">zenodo_directory</span><span class="si">}</span><span class="s2">/v7_CMIP5_pub/&quot;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">zenodo_directory</span><span class="o">.</span><span class="n">endswith</span><span class="p">(</span><span class="s2">&quot;v7_CMIP5_pub&quot;</span><span class="p">)</span>
        <span class="k">else</span> <span class="n">zenodo_directory</span>
    <span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_all_filepaths</span><span class="p">(</span><span class="n">directory</span><span class="p">,</span> <span class="n">contains</span><span class="o">=</span><span class="s2">&quot;rm&quot;</span><span class="p">,</span> <span class="n">not_contains</span><span class="o">=</span><span class="s2">&quot;ctrl_proj&quot;</span><span class="p">,</span> <span class="n">filetype</span><span class="o">=</span><span class="s2">&quot;nc&quot;</span><span class="p">)</span>
    <span class="n">files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span> <span class="k">if</span> <span class="s2">&quot;historical&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">f</span><span class="p">]</span>
    <span class="n">count</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">all_files_data</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">files</span><span class="p">:</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.nc&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;/&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">exp</span> <span class="o">=</span> <span class="n">exp</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;_05&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">model</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">3</span><span class="p">]</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;.nc&#39;</span><span class="p">,</span><span class="w"> </span><span class="s1">&#39;&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">open_dataset</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">decode_times</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">dataset</span><span class="o">.</span><span class="n">time</span><span class="p">)</span> <span class="o">==</span> <span class="mi">85</span><span class="p">:</span>
            <span class="n">count</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">warnings</span><span class="o">.</span><span class="n">warn</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">f</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">}</span><span class="s2"> does not contain 86 years. Inserting a copy into the first year.&quot;</span>
            <span class="p">)</span>

            <span class="c1"># Copy the first entry</span>
            <span class="n">first_entry</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">isel</span><span class="p">({</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">})</span>
            <span class="c1"># Assuming numeric coordinates, create a new coordinate value</span>
            <span class="n">new_coord_value</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">first_entry</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span> <span class="o">-</span> <span class="mi">1</span>
            <span class="p">)</span>  <span class="c1"># Adjust this calculation based on your coordinate system</span>
            <span class="c1"># Set the new coordinate value for the copied entry</span>
            <span class="n">first_entry</span><span class="p">[</span><span class="s2">&quot;time&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">new_coord_value</span>
            <span class="c1"># Concatenate the new entry with the original dataset</span>
            <span class="n">dataset</span> <span class="o">=</span> <span class="n">xr</span><span class="o">.</span><span class="n">concat</span><span class="p">([</span><span class="n">first_entry</span><span class="p">,</span> <span class="n">dataset</span><span class="p">],</span> <span class="n">dim</span><span class="o">=</span><span class="s2">&quot;time&quot;</span><span class="p">)</span>

        <span class="n">sector_mapping</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;1&quot;</span><span class="p">:</span> <span class="s2">&quot;no&quot;</span><span class="p">,</span> <span class="s2">&quot;2&quot;</span><span class="p">:</span> <span class="s2">&quot;ne&quot;</span><span class="p">,</span> <span class="s2">&quot;3&quot;</span><span class="p">:</span> <span class="s2">&quot;se&quot;</span><span class="p">,</span> <span class="s2">&quot;4&quot;</span><span class="p">:</span> <span class="s2">&quot;sw&quot;</span><span class="p">,</span> <span class="s2">&quot;5&quot;</span><span class="p">:</span> <span class="s2">&quot;cw&quot;</span><span class="p">,</span> <span class="s2">&quot;6&quot;</span><span class="p">:</span> <span class="s2">&quot;nw&quot;</span><span class="p">}</span>
        <span class="c1"># dataset = convert_and_subset_times(dataset)</span>
        <span class="n">all_sectors</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">sector</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">7</span><span class="p">):</span>
            <span class="n">var_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;ivaf_</span><span class="si">{</span><span class="n">sector_mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">sector</span><span class="p">)]</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">sector_x_data</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span><span class="o">.</span><span class="n">to_dataframe</span><span class="p">()</span><span class="o">.</span><span class="n">reset_index</span><span class="p">(</span><span class="n">drop</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="o">.</span><span class="n">rename</span><span class="p">(</span><span class="n">columns</span><span class="o">=</span><span class="p">{</span><span class="n">var_name</span><span class="p">:</span> <span class="s2">&quot;ivaf&quot;</span><span class="p">},</span> <span class="n">inplace</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;sector&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">sector</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;year&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">87</span><span class="p">)</span>
            <span class="n">sector_x_data</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">model</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">exp</span><span class="si">}</span><span class="s2">_sector</span><span class="si">{</span><span class="n">sector</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="n">all_sectors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sector_x_data</span><span class="p">)</span>
        <span class="n">full_dataset</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_sectors</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">full_dataset</span><span class="p">[</span><span class="s2">&quot;exp&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exp</span>
        <span class="n">full_dataset</span><span class="p">[</span><span class="s2">&quot;model&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">model</span>
        <span class="n">all_files_data</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_dataset</span><span class="p">)</span>
    <span class="n">outputs</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">concat</span><span class="p">(</span><span class="n">all_files_data</span><span class="p">)</span>
    <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;sle&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">outputs</span><span class="p">[</span><span class="s2">&quot;ivaf&quot;</span><span class="p">]</span> <span class="o">/</span> <span class="mf">362.5</span> <span class="o">/</span> <span class="mf">1e9</span>

    <span class="k">return</span> <span class="n">outputs</span></div>



<div class="viewcode-block" id="process_sectors">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.process_sectors">[docs]</a>
<span class="k">def</span> <span class="nf">process_sectors</span><span class="p">(</span>
    <span class="n">ice_sheet</span><span class="p">,</span>
    <span class="n">forcing_directory</span><span class="p">,</span>
    <span class="n">grid_file</span><span class="p">,</span>
    <span class="n">zenodo_directory</span><span class="p">,</span>
    <span class="n">experiments_file</span><span class="p">,</span>
    <span class="n">export_directory</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="n">with_ctrl</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>

    <span class="n">forcing_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/forcings.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">forcing_exists</span> <span class="ow">or</span> <span class="p">(</span><span class="n">forcing_exists</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">):</span>
        
        <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">process_AIS_atmospheric_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span>
            <span class="k">else</span> <span class="n">process_GrIS_atmospheric_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">atmospheric_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_atmospheric.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
        <span class="n">oceanic_df</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">process_AIS_oceanic_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span>
            <span class="k">else</span> <span class="n">process_GrIS_oceanic_sectors</span><span class="p">(</span><span class="n">forcing_directory</span><span class="p">,</span> <span class="n">grid_file</span><span class="p">)</span>
        <span class="p">)</span>
        <span class="n">oceanic_df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_oceanic.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

        <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_atmospheric.csv&quot;</span><span class="p">)</span>
        <span class="n">oceanic_df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">ice_sheet</span><span class="si">}</span><span class="s2">_oceanic.csv&quot;</span><span class="p">)</span>
        <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="n">atmospheric_df</span><span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">atmospheric_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;.1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]]</span>
        <span class="n">oceanic_df</span> <span class="o">=</span> <span class="n">oceanic_df</span><span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">oceanic_df</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;.1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]]</span>

        <span class="n">atmospheric_df</span> <span class="o">=</span> <span class="n">atmospheric_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">atmospheric_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
        <span class="n">oceanic_df</span> <span class="o">=</span> <span class="n">oceanic_df</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">oceanic_df</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
        <span class="n">forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">merge</span><span class="p">(</span>
            <span class="n">atmospheric_df</span><span class="p">,</span>
            <span class="n">oceanic_df</span><span class="p">,</span>
            <span class="n">on</span><span class="o">=</span><span class="p">[</span>
                <span class="s2">&quot;aogcm&quot;</span><span class="p">,</span>
                <span class="s2">&quot;year&quot;</span><span class="p">,</span>
                <span class="s2">&quot;sector&quot;</span><span class="p">,</span>
            <span class="p">],</span>
            <span class="n">how</span><span class="o">=</span><span class="s2">&quot;inner&quot;</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="n">forcings</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/forcings.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">forcings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/forcings.csv&quot;</span><span class="p">)</span>

    <span class="n">projections_exists</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/projections.csv&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">projections_exists</span> <span class="ow">or</span> <span class="p">(</span><span class="n">projections_exists</span> <span class="ow">and</span> <span class="n">overwrite</span><span class="p">):</span>
        <span class="n">projections</span> <span class="o">=</span> <span class="p">(</span>
            <span class="n">process_AIS_outputs</span><span class="p">(</span>
                <span class="n">zenodo_directory</span><span class="p">,</span>
                <span class="n">with_ctrl</span><span class="o">=</span><span class="n">with_ctrl</span><span class="p">,</span>
            <span class="p">)</span>
            <span class="k">if</span> <span class="n">ice_sheet</span> <span class="o">==</span> <span class="s2">&quot;AIS&quot;</span>
            <span class="k">else</span> <span class="n">process_GrIS_outputs</span><span class="p">(</span>
                <span class="n">zenodo_directory</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="n">projections</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/projections.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">projections</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/projections.csv&quot;</span><span class="p">)</span>

    <span class="n">projections</span> <span class="o">=</span> <span class="n">projections</span><span class="o">.</span><span class="n">loc</span><span class="p">[:,</span> <span class="o">~</span><span class="n">projections</span><span class="o">.</span><span class="n">columns</span><span class="o">.</span><span class="n">duplicated</span><span class="p">()]</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">merge_datasets</span><span class="p">(</span>
        <span class="n">forcings</span><span class="p">,</span>
        <span class="n">projections</span><span class="p">,</span>
        <span class="n">experiments_file</span><span class="p">,</span>
        <span class="n">ice_sheet</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">dataset</span> <span class="o">=</span> <span class="n">dataset</span><span class="p">[[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">dataset</span><span class="o">.</span><span class="n">columns</span> <span class="k">if</span> <span class="s2">&quot;.1&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]]</span>

    <span class="k">if</span> <span class="n">export_directory</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">dataset</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">export_directory</span><span class="si">}</span><span class="s2">/dataset.csv&quot;</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">dataset</span></div>



<span class="k">def</span> <span class="nf">_format_AIS_ocean_aogcm_name</span><span class="p">(</span><span class="n">aogcm</span><span class="p">):</span>
    <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5a-mr_rcp2.6&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5a-mr_rcp8.5&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;hadgem2-es_rcp8.5&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;csiro-mk3-6-0_rcp8.5&quot;</span>
    <span class="p">):</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="p">(</span>
        <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;cnrm-cm6-1_ssp585&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;cnrm-esm2-1_ssp585&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;cnrm-cm6-1_ssp126&quot;</span>
    <span class="p">):</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-1&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="s2">&quot;_&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ukesm1-0-ll_ssp585&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;ukesm1-0-ll&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">aogcm</span>


<span class="k">def</span> <span class="nf">_format_AIS_forcings_aogcm_name</span><span class="p">(</span><span class="n">aogcm</span><span class="p">):</span>
    <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="p">(</span>
        <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;noresm1-m_rcp2.6&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;noresm1-m_rcp8.5&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;miroc-esm-chem_rcp8.5&quot;</span>
        <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ccsm4_rcp8.5&quot;</span>
    <span class="p">):</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;csiro-mk3-6-0_rcp85&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;csiro-mk3.6_rcp85&quot;</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5a-mr_rcp26&quot;</span> <span class="ow">or</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ipsl-cm5a-mr_rcp85&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">aogcm</span>


<span class="k">def</span> <span class="nf">_format_GrIS_forcings_aogcm_name</span><span class="p">(</span><span class="n">aogcm</span><span class="p">):</span>
    <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;noresm1_rcp85&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;noresm1-m_rcp85&quot;</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ukesm1-cm6_ssp585&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;ukesm1-0-ll_ssp585&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">aogcm</span>


<div class="viewcode-block" id="format_GrIS_atmospheric_aogcm_name">
<a class="viewcode-back" href="../../../docs/source/ise.data.html#ise.data.process.format_GrIS_atmospheric_aogcm_name">[docs]</a>
<span class="k">def</span> <span class="nf">format_GrIS_atmospheric_aogcm_name</span><span class="p">(</span><span class="n">aogcm</span><span class="p">):</span>
    <span class="n">modified_string</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">rsplit</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">return</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">modified_string</span><span class="p">)</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span></div>



<span class="k">def</span> <span class="nf">_format_GrIS_ocean_aogcm_name</span><span class="p">(</span><span class="n">aogcm</span><span class="p">):</span>
    <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">lower</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;access1-3_rcp8.5&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;access1.3_rcp85&quot;</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;csiro-mk3.6_rcp8.5&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;8.5&quot;</span><span class="p">,</span> <span class="s2">&quot;85&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="ow">in</span> <span class="p">(</span>
        <span class="s2">&quot;hadgem2-es_rcp8.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;ipsl-cm5-mr_rcp8.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;miroc5_rcp2.6&quot;</span><span class="p">,</span>
        <span class="s2">&quot;miroc5_rcp8.5&quot;</span><span class="p">,</span>
        <span class="s2">&quot;miroc5_rcp8.5&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="n">aogcm</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;noresm1-m_rcp8.5&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;noresm1_rcp85&quot;</span>
    <span class="k">elif</span> <span class="n">aogcm</span> <span class="o">==</span> <span class="s2">&quot;ukesm1-0-ll_ssp585&quot;</span><span class="p">:</span>
        <span class="n">aogcm</span> <span class="o">=</span> <span class="s2">&quot;ukesm1-cm6_ssp585&quot;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="n">aogcm</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2025, Peter Van Katwyk.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>